<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QC Tag Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .tag-form {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-family: 'Courier New', Courier, monospace;
      color: #000;
    }
    .tag-field {
      display: flex;
      justify-content: space-between;
      padding: 0 8px;
      line-height: 1.3;
    }
    .tag-field label {
      font-weight: bold;
      font-size: 14px;
      min-width: 110px;
      color: #333;
    }
    .tag-field input,
    .tag-field textarea {
      border: none;
      background: transparent;
      width: 120px;
      font-size: 14px;
      text-align: left;
      border-bottom: 1px dashed #666;
    }
    .tag-field input:focus,
    .tag-field textarea:focus {
      outline: none;
      border-bottom: 1px solid #000;
    }
    #formTitle {
      padding: 4px 8px;
      font-size: 16px;
      margin: -6px -12px 8px -12px;
      color: #FFF;
    }
    #formTitle.accept { background: #22c55e; }
    #formTitle.reject { background: #ef4444; }
    #formTitle.identification { background: #2563eb; }
    #formContainer {
      border: 2px solid #2563eb;
      padding: 12px;
      background: #FFF;
      width: 70%;
      margin: 0 auto;
    }
    #historyContainer {
      margin-top: 20px;
      padding: 12px;
      background: #FFF;
      border: 2px solid #2563eb;
      width: 70%;
      margin: 20px auto;
    }
    #historyTable {
      width: 100%;
      border-collapse: collapse;
    }
    #historyTable thead {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: #f2f2f2;
    }
    #historyTable th,
    #historyTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #historyTable th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .dark-mode {
      background-color: #1f2937;
      color: #f3f4f6;
    }
    .dark-mode #formContainer, .dark-mode #historyContainer {
      background-color: #374151;
      border-color: #60a5fa;
    }
    .dark-mode #formTitle {
      background-color: #2563eb;
    }
    .dark-mode #historyTable th {
      background-color: #4b5563;
    }
    @media (max-width: 640px) {
      .tag-field {
        flex-direction: column;
        align-items: flex-start;
      }
      .tag-field input, .tag-field textarea {
        width: 100%;
      }
      #formContainer, #historyContainer {
        width: 95%;
      }
    }
    @media print {
      body {
        margin: 0;
        padding: 0;
      }
      nav, button, #historyContainer, #stats, #chartContainer, #loading, #filterType, #importExcel {
        display: none;
      }
      #formContainer {
        width: 10cm;
        height: 8cm;
        margin: 0;
        padding: 10px;
        border: 2px solid #2563eb;
        background: #FFF;
        box-shadow: none;
        overflow: hidden;
        page-break-after: always;
      }
      .tag-form {
        font-size: 12px;
        line-height: 1.2;
      }
      .tag-field label {
        font-size: 12px;
      }
      .tag-field input, .tag-field textarea {
        font-size: 12px;
        border-bottom: none;
      }
      #formTitle {
        font-size: 14px;
        margin: -4px -10px 6px -10px;
      }
      .print-tag-container {
        page-break-after: always;
      }
      .tag-number {
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 6px;
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div id="loading" class="hidden fixed inset-0 bg-gray-500 bg-opacity-50 flex items-center justify-center">
    <div class="animate-spin h-8 w-8 border-4 border-blue-600 rounded-full border-t-transparent"></div>
  </div>
  <nav class="bg-blue-600 p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <h1 class="text-white text-xl font-bold">QC Tag Management</h1>
      <div class="space-x-4">
        <button id="acceptBtn" class="text-white hover:bg-blue-700 px-3 py-2 rounded">Accept Tag</button>
        <button id="identificationBtn" class="text-white hover:bg-blue-700 px-3 py-2 rounded">Identification Tag</button>
        <button id="rejectBtn" class="text-white hover:bg-blue-700 px-3 py-2 rounded">Reject Tag</button>
        <button id="numTagsBtn" class="text-white hover:bg-blue-700 px-3 py-2 rounded">No of Tags</button>
        <button id="exportExcelBtn" class="text-white hover:bg-blue-700 px-3 py-2 rounded">Export to Excel</button>
        <button id="backupBtn" class="text-white hover:bg-blue-700 px-3 py-2 rounded">Backup Tags</button>
        <button id="themeToggle" class="text-white hover:bg-blue-700 px-3 py-2 rounded">Toggle Dark Mode</button>
        <button id="clearStorageBtn" class="text-white hover:bg-red-700 px-3 py-2 rounded">Clear Storage</button>
      </div>
    </div>
  </nav>
  <div class="container mx-auto mt-8 p-4">
    <div id="stats" class="mb-4 bg-white p-4 rounded-lg shadow-md">
      <p>Total Tags: <span id="totalTags">0</span></p>
      <p>Accept Tags: <span id="acceptTags">0</span></p>
      <p>Reject Tags: <span id="rejectTags">0</span></p>
      <p>Identification Tags: <span id="idTags">0</span></p>
    </div>
    <div class="mb-4 flex items-center space-x-4">
      <div>
        <label for="filterType" class="mr-2">Filter by Tag Type:</label>
        <select id="filterType" class="border p-2 rounded">
          <option value="all">All</option>
          <option value="accept">Accept</option>
          <option value="identification">Identification</option>
          <option value="reject">Reject</option>
        </select>
      </div>
      <input type="file" id="importExcel" accept=".xlsx, .xls" class="border p-2 rounded">
    </div>
    <div id="formContainer" class="bg-white rounded-lg shadow-md">
      <h2 id="formTitle" class="text-2xl font-bold mb-4 identification">IDENTIFICATION TAG</h2>
      <form id="qcForm" class="tag-form">
        <div class="tag-field">
          <label for="qcNo">Q.C. No.</label>
          <input type="text" id="qcNo" name="qcNo" required>
        </div>
        <div class="tag-field">
          <label for="date">Date :</label>
          <input type="date" id="date" name="date" required>
        </div>
        <div class="tag-field">
          <label for="project">Project / PO</label>
          <input type="text" id="project" name="project" required>
        </div>
        <div class="tag-field">
          <label for="vendor">Vendor Name</label>
          <input type="text" id="vendor" name="vendor" required>
        </div>
        <div class="tag-field">
          <label for="component">Component</label>
          <input type="text" id="component" name="component" required>
        </div>
        <div class="tag-field">
          <label for="drawingNo">Drawing No.</label>
          <input type="text" id="drawingNo" name="drawingNo" required>
        </div>
        <div class="tag-field">
          <label for="remarks">Remarks</label>
          <textarea id="remarks" name="remarks" rows="2"></textarea>
        </div>
        <div class="tag-field">
          <label for="quantity">Qty</label>
          <input type="number" id="quantity" name="quantity" min="1" required>
        </div>
        <div class="tag-field">
          <label for="signature">Signature</label>
          <input type="text" id="signature" name="signature" required>
        </div>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 mt-4">Submit Tag</button>
        <button type="button" id="printBtn" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 mt-2">Print Tag</button>
        <button type="button" id="clearBtn" class="w-full bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700 mt-2">Clear Form</button>
      </form>
    </div>
    <div id="historyContainer" class="bg-white rounded-lg shadow-md">
      <h2 class="text-xl font-bold mb-4 bg-blue-600 text-white p-4">Tag History</h2>
      <table id="historyTable">
        <thead>
          <tr>
            <th>Tag Type</th>
            <th>QC No.</th>
            <th>Date</th>
            <th>Project</th>
            <th>Vendor</th>
            <th>Component</th>
            <th>Drawing No.</th>
            <th>Remarks</th>
            <th>Quantity</th>
            <th>Signature</th>
            <th>Tag Number</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
    <div id="chartContainer" class="mt-4 bg-white p-4 rounded-lg shadow-md">
      <canvas id="tagChart"></canvas>
    </div>
  </div>
  <script>
    // Utility Functions
    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    function debounce(func, wait) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
      };
    }

    function saveTags(tags) {
      try {
        localStorage.setItem('qcTags', JSON.stringify(tags));
      } catch (error) {
        if (error.name === 'QuotaExceededError') {
          alert('Storage limit exceeded. Please export and clear some tags.');
        } else {
          console.error('Error saving tags:', error);
          alert('Failed to save tags. Please try again.');
        }
      }
    }

    function getNextTagNumber() {
      let tagCounter = parseInt(localStorage.getItem('tagCounter') || '0', 10);
      tagCounter += 1;
      localStorage.setItem('tagCounter', tagCounter);
      return tagCounter;
    }

    // Form Handling
    const buttons = {
      accept: document.getElementById('acceptBtn'),
      identification: document.getElementById('identificationBtn'),
      reject: document.getElementById('rejectBtn'),
      numTags: document.getElementById('numTagsBtn'),
      print: document.getElementById('printBtn'),
      clear: document.getElementById('clearBtn'),
      clearStorage: document.getElementById('clearStorageBtn'),
      exportExcel: document.getElementById('exportExcelBtn'),
      backup: document.getElementById('backupBtn'),
      themeToggle: document.getElementById('themeToggle')
    };
    const formTitle = document.getElementById('formTitle');
    const qcForm = document.getElementById('qcForm');
    const dateInput = document.getElementById('date');
    const historyBody = document.getElementById('historyBody');
    const filterType = document.getElementById('filterType');
    const importExcel = document.getElementById('importExcel');
    const loading = document.getElementById('loading');
    let numTags = 1;
    let lastSubmittedTags = [];
    let editingTag = null;

    const today = new Date().toISOString().split('T')[0];
    dateInput.value = today;

    function updateForm(tagType) {
      formTitle.className = tagType;
      formTitle.textContent = `${tagType.toUpperCase()} TAG`;
      qcForm.dataset.tagType = tagType;
      Object.values(buttons).forEach(btn => btn.classList.remove('bg-blue-700', 'bg-green-700', 'bg-gray-700', 'bg-red-700'));
      if (tagType !== 'numTags') {
        buttons[tagType]?.classList.add(tagType === 'print' ? 'bg-green-700' : tagType === 'clear' ? 'bg-gray-700' : tagType === 'clearStorage' ? 'bg-red-700' : 'bg-blue-700');
      }
    }

    function printSingleTag(tag) {
      const printContainer = document.createElement('div');
      printContainer.style.display = 'none';
      document.body.appendChild(printContainer);
      const formClone = document.createElement('div');
      formClone.classList.add('print-tag-container', 'bg-white');
      formClone.innerHTML = `
        <div id="formContainer" class="bg-white">
          <h2 id="formTitle" class="${tag.tagType}">${tag.tagType.toUpperCase()} TAG</h2>
          <div class="tag-number">Tag ${tag.tagNumber}</div>
          <div class="tag-form">
            <div class="tag-field"><label>Q.C. No.</label><input type="text" value="${sanitizeInput(tag.qcNo)}" readonly></div>
            <div class="tag-field"><label>Date :</label><input type="text" value="${sanitizeInput(tag.date)}" readonly></div>
            <div class="tag-field"><label>Project / PO</label><input type="text" value="${sanitizeInput(tag.project)}" readonly></div>
            <div class="tag-field"><label>Vendor Name</label><input type="text" value="${sanitizeInput(tag.vendor)}" readonly></div>
            <div class="tag-field"><label>Component</label><input type="text" value="${sanitizeInput(tag.component)}" readonly></div>
            <div class="tag-field"><label>Drawing No.</label><input type="text" value="${sanitizeInput(tag.drawingNo)}" readonly></div>
            <div class="tag-field"><label>Remarks</label><textarea rows="2" readonly>${sanitizeInput(tag.remarks)}</textarea></div>
            <div class="tag-field"><label>Qty</label><input type="number" value="${sanitizeInput(tag.quantity)}" readonly></div>
            <div class="tag-field"><label>Signature</label><input type="text" value="${sanitizeInput(tag.signature)}" readonly></div>
          </div>
        </div>
      `;
      printContainer.appendChild(formClone);
      window.print();
      setTimeout(() => printContainer.remove(), 1000);
    }

    function loadTagHistory() {
      try {
        const tags = JSON.parse(localStorage.getItem('qcTags') || '[]');
        const filter = filterType.value;
        historyBody.innerHTML = '';
        tags
          .filter(tag => filter === 'all' || tag.tagType === filter)
          .forEach(tag => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${sanitizeInput(tag.tagType.charAt(0).toUpperCase() + tag.tagType.slice(1))}</td>
              <td>${sanitizeInput(tag.qcNo)}</td>
              <td>${sanitizeInput(tag.date)}</td>
              <td>${sanitizeInput(tag.project)}</td>
              <td>${sanitizeInput(tag.vendor)}</td>
              <td>${sanitizeInput(tag.component)}</td>
              <td>${sanitizeInput(tag.drawingNo)}</td>
              <td>${sanitizeInput(tag.remarks)}</td>
              <td>${sanitizeInput(tag.quantity)}</td>
              <td>${sanitizeInput(tag.signature)}</td>
              <td>${sanitizeInput(tag.tagNumber)}</td>
              <td>
                <button class="print-history-btn bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">Print</button>
                <button class="edit-btn bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Edit</button>
                <button class="delete-btn bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">Delete</button>
              </td>
            `;
            row.querySelector('.print-history-btn').addEventListener('click', () => printSingleTag(tag));
            row.querySelector('.edit-btn').addEventListener('click', () => {
              editingTag = tag;
              updateForm(tag.tagType);
              qcForm.qcNo.value = tag.qcNo;
              qcForm.date.value = tag.date;
              qcForm.project.value = tag.project;
              qcForm.vendor.value = tag.vendor;
              qcForm.component.value = tag.component;
              qcForm.drawingNo.value = tag.drawingNo;
              qcForm.remarks.value = tag.remarks;
              qcForm.quantity.value = tag.quantity;
              qcForm.signature.value = tag.signature;
            });
            row.querySelector('.delete-btn').addEventListener('click', () => {
              if (confirm('Are you sure you want to delete this tag?')) {
                const updatedTags = tags.filter(t => t.tagNumber !== tag.tagNumber || t.qcNo !== tag.qcNo);
                saveTags(updatedTags);
                loadTagHistory();
                updateStats();
                updateChart();
              }
            });
            historyBody.appendChild(row);
          });
        updateStats();
        updateChart();
      } catch (error) {
        console.error('Error loading tags:', error);
        alert('Failed to load tag history. Please try again.');
      }
    }

    function updateStats() {
      const tags = JSON.parse(localStorage.getItem('qcTags') || '[]');
      document.getElementById('totalTags').textContent = tags.length;
      document.getElementById('acceptTags').textContent = tags.filter(t => t.tagType === 'accept').length;
      document.getElementById('rejectTags').textContent = tags.filter(t => t.tagType === 'reject').length;
      document.getElementById('idTags').textContent = tags.filter(t => t.tagType === 'identification').length;
    }

    function updateChart() {
      const tags = JSON.parse(localStorage.getItem('qcTags') || '[]');
      const tagCounts = {
        accept: tags.filter(t => t.tagType === 'accept').length,
        reject: tags.filter(t => t.tagType === 'reject').length,
        identification: tags.filter(t => t.tagType === 'identification').length
      };
      const ctx = document.getElementById('tagChart').getContext('2d');
      if (window.tagChart) window.tagChart.destroy();
      window.tagChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Accept', 'Reject', 'Identification'],
          datasets: [{
            data: [tagCounts.accept, tagCounts.reject, tagCounts.identification],
            backgroundColor: ['#22c55e', '#ef4444', '#2563eb']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: 'Tag Distribution by Type' }
          }
        }
      });
    }

    buttons.accept.addEventListener('click', () => updateForm('accept'));
    buttons.identification.addEventListener('click', () => updateForm('identification'));
    buttons.reject.addEventListener('click', () => updateForm('reject'));
    buttons.numTags.addEventListener('click', () => {
      const input = prompt('Enter the number of tags to submit (1-100):', numTags);
      const parsedInput = parseInt(input, 10);
      if (isNaN(parsedInput) || parsedInput < 1 || parsedInput > 100) {
        alert('Please enter a number between 1 and 100.');
      } else {
        numTags = parsedInput;
        alert(`Number of tags set to ${numTags}.`);
        buttons.numTags.classList.add('bg-blue-700');
      }
    });
    buttons.clear.addEventListener('click', () => {
      qcForm.reset();
      dateInput.value = today;
      updateForm('identification');
      numTags = 1;
      editingTag = null;
      buttons.numTags.classList.remove('bg-blue-700');
    });
    buttons.clearStorage.addEventListener('click', () => {
      if (confirm('Are you sure you want to clear all stored tag data? This action cannot be undone.')) {
        localStorage.removeItem('qcTags');
        localStorage.removeItem('tagCounter');
        lastSubmittedTags = [];
        loadTagHistory();
        alert('All stored tag data has been cleared.');
        buttons.clearStorage.classList.add('bg-red-700');
      }
    });
    buttons.exportExcel.addEventListener('click', () => {
      loading.classList.remove('hidden');
      setTimeout(() => {
        const tags = JSON.parse(localStorage.getItem('qcTags') || '[]');
        if (tags.length === 0) {
          alert('No tag data available to export.');
          loading.classList.add('hidden');
          return;
        }
        const worksheetData = tags.map(tag => ({
          'Tag Type': tag.tagType.charAt(0).toUpperCase() + tag.tagType.slice(1),
          'QC No.': tag.qcNo,
          'Date': tag.date,
          'Project': tag.project,
          'Vendor': tag.vendor,
          'Component': tag.component,
          'Drawing No.': tag.drawingNo,
          'Remarks': tag.remarks,
          'Quantity': tag.quantity,
          'Signature': tag.signature,
          'Tag Number': tag.tagNumber
        }));
        const worksheet = XLSX.utils.json_to_sheet(worksheetData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Tag History');
        worksheet['!cols'] = [
          { wch: 15 }, { wch: 10 }, { wch: 12 }, { wch: 20 }, { wch: 20 },
          { wch: 20 }, { wch: 15 }, { wch: 30 }, { wch: 10 }, { wch: 15 }, { wch: 12 }
        ];
        XLSX.write(workbook, 'QCTagHistory.xlsx');
        alert('Tag history exported to Excel successfully.');
        loading.classList.add('hidden');
      }, 100);
    });
    buttons.backup.addEventListener('click', () => {
      const tags = JSON.parse(localStorage.getItem('qcTags') || '[]');
      const blob = new Blob([JSON.stringify(tags, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'QCTagBackup.json';
      a.click();
      URL.revokeObjectURL(url);
    });
    buttons.themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    });
    importExcel.addEventListener('change', (e) => {
      loading.classList.remove('hidden');
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const tags = XLSX.utils.sheet_to_json(sheet);
          const existingTags = JSON.parse(localStorage.getItem('qcTags') || '[]');
          tags.forEach(tag => {
            tag.tagNumber = getNextTagNumber();
            tag.tagType = tag['Tag Type']?.toLowerCase() || 'identification';
            existingTags.push({
              tagType: tag.tagType,
              qcNo: tag['QC No.'] || '',
              date: tag.Date || today,
              project: tag.Project || '',
              vendor: tag.Vendor || '',
              component: tag.Component || '',
              drawingNo: tag['Drawing No.'] || '',
              remarks: tag.Remarks || '',
              quantity: tag.Quantity || 1,
              signature: tag.Signature || '',
              tagNumber: tag.tagNumber
            });
          });
          saveTags(existingTags);
          loadTagHistory();
          alert('Tags imported successfully.');
        } catch (error) {
          console.error('Error importing tags:', error);
          alert('Failed to import tags. Please ensure the file is valid.');
        } finally {
          loading.classList.add('hidden');
          importExcel.value = '';
        }
      };
      reader.readAsArrayBuffer(file);
    });
    buttons.print.addEventListener('click', () => {
      if (lastSubmittedTags.length === 0) {
        alert('No tags have been submitted yet. Please submit a tag before printing.');
        return;
      }
      const printNumTags = parseInt(prompt('Enter the number of tags to print (1-8):', '1'), 10);
      if (isNaN(printNumTags) || printNumTags < 1 || printNumTags > 8) {
        alert('Please enter a number of tags between 1 and 8 for printing.');
        return;
      }
      const printContainer = document.createElement('div');
      printContainer.style.display = 'none';
      document.body.appendChild(printContainer);
      for (let i = 0; i < Math.min(printNumTags, lastSubmittedTags.length); i++) {
        const tag = lastSubmittedTags[i];
        const formClone = document.createElement('div');
        formClone.classList.add('print-tag-container', 'bg-white');
        formClone.innerHTML = `
          <div id="formContainer" class="bg-white">
            <h2 id="formTitle" class="${tag.tagType}">${tag.tagType.toUpperCase()} TAG</h2>
            <div class="tag-number">Tag ${tag.tagNumber}</div>
            <div class="tag-form">
              <div class="tag-field"><label>Q.C. No.</label><input type="text" value="${sanitizeInput(tag.qcNo)}" readonly></div>
              <div class="tag-field"><label>Date :</label><input type="text" value="${sanitizeInput(tag.date)}" readonly></div>
              <div class="tag-field"><label>Project / PO</label><input type="text" value="${sanitizeInput(tag.project)}" readonly></div>
              <div class="tag-field"><label>Vendor Name</label><input type="text" value="${sanitizeInput(tag.vendor)}" readonly></div>
              <div class="tag-field"><label>Component</label><input type="text" value="${sanitizeInput(tag.component)}" readonly></div>
              <div class="tag-field"><label>Drawing No.</label><input type="text" value="${sanitizeInput(tag.drawingNo)}" readonly></div>
              <div class="tag-field"><label>Remarks</label><textarea rows="2" readonly>${sanitizeInput(tag.remarks)}</textarea></div>
              <div class="tag-field"><label>Qty</label><input type="number" value="${sanitizeInput(tag.quantity)}" readonly></div>
              <div class="tag-field"><label>Signature</label><input type="text" value="${sanitizeInput(tag.signature)}" readonly></div>
            </div>
          </div>
        `;
        printContainer.appendChild(formClone);
      }
      window.print();
      setTimeout(() => printContainer.remove(), 1000);
    });

    qcForm.addEventListener('submit', debounce((e) => {
      e.preventDefault();
      const formData = new FormData(qcForm);
      const tags = JSON.parse(localStorage.getItem('qcTags') || '[]');
      const qcNo = sanitizeInput(formData.get('qcNo'));
      if (!editingTag && tags.some(tag => tag.qcNo === qcNo)) {
        alert('QC Number must be unique.');
        return;
      }
      const tagData = {
        tagType: qcForm.dataset.tagType || 'identification',
        qcNo: qcNo,
        date: sanitizeInput(formData.get('date')),
        project: sanitizeInput(formData.get('project')),
        vendor: sanitizeInput(formData.get('vendor')),
        component: sanitizeInput(formData.get('component')),
        drawingNo: sanitizeInput(formData.get('drawingNo')),
        remarks: sanitizeInput(formData.get('remarks')),
        quantity: sanitizeInput(formData.get('quantity')),
        signature: sanitizeInput(formData.get('signature'))
      };
      lastSubmittedTags = [];
      if (editingTag) {
        const updatedTags = tags.map(t => (t.tagNumber === editingTag.tagNumber && t.qcNo === editingTag.qcNo ? { ...tagData, tagNumber: t.tagNumber } : t));
        saveTags(updatedTags);
        editingTag = null;
      } else {
        for (let i = 0; i < numTags; i++) {
          lastSubmittedTags.push({ ...tagData, tagNumber: getNextTagNumber() });
        }
        saveTags([...tags, ...lastSubmittedTags]);
      }
      alert(`${editingTag ? 'Tag Updated' : numTags + ' ' + tagData.tagType.charAt(0).toUpperCase() + tagData.tagType.slice(1) + ' Tag(s) Submitted'}!\n` +
        `QC No: ${tagData.qcNo}\nDate: ${tagData.date}\nProject: ${tagData.project}\n` +
        `Vendor: ${tagData.vendor}\nComponent: ${tagData.component}\n` +
        `Drawing No: ${tagData.drawingNo}\nRemarks: ${tagData.remarks}\n` +
        `Quantity: ${tagData.quantity}\nSignature: ${tagData.signature}${editingTag ? '' : '\nNumber of Tags: ' + numTags}`);
      qcForm.reset();
      dateInput.value = today;
      updateForm('identification');
      numTags = 1;
      buttons.numTags.classList.remove('bg-blue-700');
      loadTagHistory();
    }, 300));

    filterType.addEventListener('change', loadTagHistory);
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        qcForm.dispatchEvent(new Event('submit'));
      } else if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        buttons.print.click();
      }
    });

    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark-mode');
    }
    updateForm('identification');
    loadTagHistory();
  </script>
</body>
</html>
