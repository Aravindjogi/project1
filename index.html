<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Ambulance Tracker</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <style>

        :root {

            --primary: #2563eb;

            --primary-dark: #1e40af;

            --accent: #059669;

            --neutral: #d1d5db;

            --text: #1f2937;

            --error: #dc2626;

            --bg-light: #f3f4f6;

            --bg-dark: #111827;

            --text-dark: #e5e7eb;

            --shadow: 0 6px 12px rgba(0,0,0,0.15);

            --success: #16a34a;

            --warning: #d97706;

        }

        * {

            box-sizing: border-box;

        }

        body {

            font-family: 'Roboto', sans-serif;

            margin: 0;

            padding: 0;

            background-color: var(--bg-light);

            color: var(--text);

            transition: background-color 0.3s, color 0.3s;

        }

        body.dark-mode {

            background-color: var(--bg-dark);

            color: var(--text-dark);

        }

        h1, h2, h3 {

            font-family: 'Montserrat', sans-serif;

            font-weight: 700;

        }

        .navbar {

            background: linear-gradient(90deg, var(--primary), var(--primary-dark));

            padding: 1rem;

            box-shadow: var(--shadow);

            position: sticky;

            top: 0;

            z-index: 1000;

        }

        .navbar-container {

            max-width: 1280px;

            margin: 0 auto;

            display: flex;

            justify-content: space-between;

            align-items: center;

        }

        .navbar ul {

            list-style: none;

            margin: 0;

            padding: 0;

            display: flex;

            align-items: center;

            gap: 1.5rem;

        }

        .navbar a, .navbar .dropdown-toggle {

            color: white;

            text-decoration: none;

            font-weight: 500;

            font-size: 1rem;

            padding: 0.5rem 1rem;

            border-radius: 0.5rem;

            transition: background 0.3s, transform 0.2s;

            cursor: pointer;

        }

        .navbar a:hover, .navbar .dropdown-toggle:hover {

            background: var(--primary-dark);

            transform: scale(1.05);

        }

        .dropdown {

            position: relative;

        }

        .dropdown-menu {

            display: none;

            position: absolute;

            top: 100%;

            right: 0;

            background: white;

            border-radius: 0.5rem;

            box-shadow: var(--shadow);

            min-width: 180px;

            z-index: 1001;

            animation: slideIn 0.2s ease;

        }

        body.dark-mode .dropdown-menu {

            background: #1f2937;

        }

        .dropdown-menu a, .dropdown-menu span {

            display: block;

            padding: 0.75rem 1rem;

            color: var(--text);

            text-decoration: none;

            font-size: 0.875rem;

        }

        body.dark-mode .dropdown-menu a, body.dark-mode .dropdown-menu span {

            color: var(--text-dark);

        }

        .dropdown-menu a:hover {

            background: var(--neutral);

        }

        body.dark-mode .dropdown-menu a:hover {

            background: #374151;

        }

        .dropdown:hover .dropdown-menu {

            display: block;

        }

        .hamburger {

            display: none;

            font-size: 1.5rem;

            color: white;

            cursor: pointer;

        }

        .container {

            max-width: 1280px;

            margin: 2rem auto;

            padding: 0 1rem;

            animation: fadeIn 0.5s ease;

        }

        .header {

            text-align: center;

            background: linear-gradient(90deg, var(--primary), var(--primary-dark));

            color: white;

            padding: 2.5rem;

            border-radius: 1rem;

            margin-bottom: 2rem;

            box-shadow: var(--shadow);

        }

        .form-container, .tracker-container, .dashboard-container, .admin-container {

            background: white;

            padding: 2rem;

            border-radius: 1rem;

            box-shadow: var(--shadow);

            margin-bottom: 2rem;

            transition: transform 0.3s;

        }

        body.dark-mode .form-container, body.dark-mode .tracker-container,

        body.dark-mode .dashboard-container, body.dark-mode .admin-container {

            background: #1f2937;

        }

        .form-grid {

            display: grid;

            grid-template-columns: 1fr;

            gap: 1rem;

        }

        input, select, button, textarea {

            padding: 0.75rem;

            margin: 0.25rem 0;

            border: 1px solid var(--neutral);

            border-radius: 0.5rem;

            font-size: 0.9375rem;

            width: 100%;

            transition: border-color 0.3s, box-shadow 0.3s;

        }

        body.dark-mode input, body.dark-mode select, body.dark-mode button, body.dark-mode textarea {

            border-color: #374151;

            background: #1f2937;

            color: var(--text-dark);

        }

        input:focus, select:focus, textarea:focus {

            border-color: var(--primary);

            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);

            outline: none;

        }

        button {

            background: var(--primary);

            color: white;

            border: none;

            cursor: pointer;

            font-weight: 500;

            padding: 0.75rem 1.5rem;

            border-radius: 0.5rem;

            transition: background 0.3s, transform 0.2s;

            position: relative;

            overflow: hidden;

        }

        button:hover {

            background: var(--primary-dark);

            transform: scale(1.03);

        }

        button:disabled {

            background: #6b7280;

            cursor: not-allowed;

        }

        button.loading::after {

            content: '';

            display: inline-block;

            width: 1rem;

            height: 1rem;

            border: 2px solid white;

            border-top: 2px solid transparent;

            border-radius: 50%;

            animation: spin 0.8s linear infinite;

            margin-left: 0.5rem;

        }

        .emergency-btn, .sos-btn {

            background: var(--error);

        }

        .emergency-btn:hover, .sos-btn:hover {

            background: #b91c1c;

        }

        .call-btn {

            background: var(--accent);

        }

        .call-btn:hover {

            background: #047857;

        }

        .theme-toggle {

            background: #4b5563;

            padding: 0.5rem 1rem;

        }

        .theme-toggle:hover {

            background: #374151;

        }

        #map, #driverMap {

            height: 500px;

            width: 100%;

            margin-top: 1.5rem;

            border-radius: 1rem;

            border: 1px solid var(--neutral);

            box-shadow: var(--shadow);

        }

        body.dark-mode #map, body.dark-mode #driverMap {

            border-color: #374151;

        }

        .map-controls {

            margin: 1rem 0;

            display: flex;

            gap: 0.75rem;

            flex-wrap: wrap;

        }

        .driver-info, .dashboard, .admin-panel, .distance-info, .location-history,

        .feedback-panel, .profile-card, .booking-card, .message-inbox, .chat-container,

        .settings-panel, .emergency-contacts {

            margin-top: 1.5rem;

            padding: 1.5rem;

            background: var(--neutral);

            border-radius: 0.75rem;

            font-size: 0.875rem;

            animation: fadeIn 0.5s ease;

        }

        body.dark-mode .driver-info, body.dark-mode .dashboard, body.dark-mode .admin-panel,

        body.dark-mode .distance-info, body.dark-mode .location-history, body.dark-mode .feedback-panel,

        body.dark-mode .profile-card, body.dark-mode .booking-card, body.dark-mode .message-inbox,

        body.dark-mode .chat-container, body.dark-mode .settings-panel, body.dark-mode .emergency-contacts {

            background: #374151;

        }

        .dashboard table, .admin-panel table, .location-history table, .feedback-panel table,

        .message-inbox table, .chat-container table, .emergency-contacts table {

            width: 100%;

            border-collapse: collapse;

            font-size: 0.875rem;

        }

        .dashboard th, .dashboard td, .admin-panel th, .admin-panel td,

        .location-history th, .location-history td, .feedback-panel th, .feedback-panel td,

        .message-inbox th, .message-inbox td, .chat-container th, .chat-container td,

        .emergency-contacts th, .emergency-contacts td {

            border: 1px solid var(--neutral);

            padding: 0.75rem;

            text-align: left;

        }

        body.dark-mode .dashboard th, body.dark-mode .dashboard td,

        body.dark-mode .admin-panel th, body.dark-mode .admin-panel td,

        body.dark-mode .location-history th, body.dark-mode .location-history td,

        body.dark-mode .feedback-panel th, body.dark-mode .feedback-panel td,

        body.dark-mode .message-inbox th, body.dark-mode .message-inbox td,

        body.dark-mode .chat-container th, body.dark-mode .chat-container td,

        body.dark-mode .emergency-contacts th, body.dark-mode .emergency-contacts td {

            border-color: #4b5563;

        }

        .dashboard th, .admin-panel th, .message-inbox th, .chat-container th,

        .emergency-contacts th {

            background: var(--primary);

            color: white;

            font-weight: 500;

        }

        .status-online { color: var(--accent); }

        .status-offline { color: #6b7280; }

        .status-available { color: var(--accent); }

        .status-busy { color: var(--warning); }

        .hidden {

            display: none;

        }

        .modal {

            display: none;

            position: fixed;

            top: 0;

            left: 0;

            width: 100%;

            height: 100%;

            background: rgba(0,0,0,0.7);

            z-index: 2000;

            justify-content: center;

            align-items: center;

        }

        .modal-content {

            background: white;

            padding: 2rem;

            border-radius: 1rem;

            max-width: 600px;

            width: 90%;

            text-align: center;

            box-shadow: var(--shadow);

            animation: slideIn 0.3s ease;

            position: relative;

        }

        body.dark-mode .modal-content {

            background: #1f2937;

        }

        .modal-content button {

            margin: 0.5rem;

        }

        .notification {

            position: fixed;

            top: 1rem;

            right: 1rem;

            background: var(--primary);

            color: white;

            padding: 1rem 1.5rem;

            border-radius: 0.5rem;

            box-shadow: var(--shadow);

            z-index: 1500;

            display: none;

            animation: slideInRight 0.3s ease;

            max-width: 320px;

            display: flex;

            align-items: center;

            gap: 0.5rem;

        }

        .notification.success {

            background: var(--success);

        }

        .notification.error {

            background: var(--error);

        }

        .notification .icon {

            font-size: 1.25rem;

        }

        .notification .close-btn {

            cursor: pointer;

            margin-left: auto;

            font-weight: bold;

        }

        .tooltip {

            position: relative;

            display: inline-block;

        }

        .tooltip .tooltiptext {

            visibility: hidden;

            width: 120px;

            background: var(--bg-dark);

            color: var(--text-dark);

            text-align: center;

            border-radius: 0.5rem;

            padding: 0.5rem;

            position: absolute;

            z-index: 1;

            bottom: 125%;

            left: 50%;

            margin-left: -60px;

            opacity: 0;

            transition: opacity 0.3s;

        }

        .tooltip:hover .tooltiptext {

            visibility: visible;

            opacity: 1;

        }

        .profile-card {

            display: flex;

            align-items: center;

            gap: 1rem;

            padding: 1.5rem;

            background: linear-gradient(135deg, var(--neutral), white);

            border-radius: 0.75rem;

        }

        body.dark-mode .profile-card {

            background: linear-gradient(135deg, #374151, #1f2937);

        }

        .profile-card img {

            width: 80px;

            height: 80px;

            border-radius: 50%;

            object-fit: cover;

            border: 2px solid var(--primary);

        }

        .booking-card {

            display: grid;

            grid-template-columns: 2fr 1fr;

            gap: 1rem;

            align-items: center;

        }

        .chat-container {

            max-height: 300px;

            overflow-y: auto;

        }

        .chat-message {

            margin: 0.5rem 0;

            padding: 0.75rem;

            border-radius: 0.5rem;

            max-width: 80%;

        }

        .chat-message.sent {

            background: var(--primary);

            color: white;

            margin-left: auto;

            border-bottom-right-radius: 0;

        }

        .chat-message.received {

            background: var(--neutral);

            margin-right: auto;

            border-bottom-left-radius: 0;

        }

        body.dark-mode .chat-message.received {

            background: #4b5563;

        }

        .error-message {

            color: var(--error);

            font-size: 0.875rem;

            margin-top: 0.25rem;

            display: none;

        }

        .live-toggle {

            display: flex;

            align-items: center;

            gap: 0.5rem;

            margin: 1rem 0;

        }

        .live-toggle input {

            width: auto;

        }

        .settings-panel label {

            display: flex;

            align-items: center;

            gap: 0.5rem;

            margin: 0.5rem 0;

        }

        .profile-upload {

            display: flex;

            flex-direction: column;

            gap: 0.5rem;

        }

        .rating {

            display: flex;

            gap: 0.25rem;

        }

        .rating input {

            display: none;

        }

        .rating label {

            font-size: 1.5rem;

            color: #d1d5db;

            cursor: pointer;

        }

        .rating input:checked ~ label,

        .rating label:hover,

        .rating label:hover ~ label {

            color: #f59e0b;

        }

        .leaflet-marker-icon {

            transition: transform 0.3s ease;

        }

        .leaflet-marker-icon:hover {

            transform: scale(1.2);

        }

        @keyframes fadeIn {

            from { opacity: 0; }

            to { opacity: 1; }

        }

        @keyframes slideIn {

            from { transform: translateY(-20px); opacity: 0; }

            to { transform: translateY(0); opacity: 1; }

        }

        @keyframes slideInRight {

            from { transform: translateX(20px); opacity: 0; }

            to { transform: translateX(0); opacity: 1; }

        }

        @keyframes spin {

            to { transform: rotate(360deg); }

        }

        @media (max-width: 768px) {

            .navbar ul {

                display: none;

                flex-direction: column;

                width: 100%;

                background: var(--primary-dark);

                padding: 1rem;

                position: absolute;

                top: 100%;

                left: 0;

            }

            .navbar ul.active {

                display: flex;

            }

            .hamburger {

                display: block;

            }

            .form-container, .tracker-container, .dashboard-container, .admin-container {

                padding: 1.5rem;

            }

            #map, #driverMap {

                height: 400px;

            }

            .modal-content {

                width: 95%;

                padding: 1.5rem;

            }

            .booking-card {

                grid-template-columns: 1fr;

            }

            .notification {

                max-width: 90%;

                right: 0.5rem;

            }

            .profile-card {

                flex-direction: column;

                text-align: center;

            }

            .profile-card img {

                width: 60px;

                height: 60px;

            }

        }

    </style>

</head>

<body>

    <div class="navbar" role="navigation" aria-label="Main navigation">

        <div class="navbar-container">

            <span class="hamburger" id="hamburger" aria-label="Toggle menu">☰</span>

            <ul id="navMenu">

                <li><a href="#" id="navHome">Home</a></li>

                <li><a href="#" id="navLogin">Login</a></li>

                <li><a href="#" id="navTracker">Track Ambulances</a></li>

                <li><a href="#" id="navDashboard">Dashboard</a></li>

                <li><button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">🌙</button></li>

                <li class="dropdown">

                    <span id="accountName" class="dropdown-toggle" aria-haspopup="true" aria-expanded="false">Account</span>

                    <div id="dropdownMenu" class="dropdown-menu" role="menu">

                        <span id="accountDetails" aria-label="Account details"></span>

                        <a href="#" id="logoutLink" style="display: none;" role="menuitem">Logout</a>

                    </div>

                </li>

            </ul>

        </div>

    </div>

    <div class="container">

        <div id="homeSection" class="header">

            <h1>Ambulance Tracker</h1>

            <p>Connect with emergency services in real-time.</p>

        </div>

        <div id="loginSection" class="form-container hidden">

            <h2>Login / Register</h2>

            <div class="form-grid">

                <div>

                    <select id="accountType" aria-label="Select account type">

                        <option value="user">User</option>

                        <option value="driver">Driver</option>

                        <option value="admin">Admin</option>

                    </select>

                </div>

                <div id="registerFields" class="hidden">

                    <input type="text" id="regName" placeholder="Full Name" aria-label="Full Name">

                    <p id="regNameError" class="error-message"></p>

                    <input type="file" id="regProfilePic" accept="image/jpeg,image/png" aria-label="Profile picture">

                    <p id="regProfilePicError" class="error-message"></p>

                    <select id="regAmbulanceType" aria-label="Ambulance Type" class="hidden">

                        <option value="Basic">Basic</option>

                        <option value="Advanced">Advanced</option>

                        <option value="ICU">ICU</option>

                    </select>

                </div>

                <div>

                    <input type="text" id="loginId" placeholder="ID (e.g., USER001, AMB001, ADMIN)" aria-label="ID" required>

                    <p id="loginIdError" class="error-message"></p>

                </div>

                <div>

                    <input type="password" id="loginPassword" placeholder="Password" aria-label="Password" required>

                    <p id="loginPasswordError" class="error-message"></p>

                </div>

                <div>

                    <button class="tooltip" id="registerBtn">

                        Register

                        <span class="tooltiptext">Create a new account</span>

                    </button>

                    <button class="tooltip" id="loginBtn">

                        Login

                        <span class="tooltiptext">Sign in to your account</span>

                    </button>

                </div>

            </div>

            <p id="loginMessage" aria-live="polite"></p>

        </div>

        <div id="userSection" class="form-container hidden">

            <h2>User Dashboard</h2>

            <div class="profile-card">

                <img id="userProfilePic" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRF////AAAAVcLTfgAAAAF0Uk5TAEDm2GYAAAATSURBVHjaYmAYBaNgFIyCUTAKAAQYACZ1A+U3AAAAAElFTkSuQmCC" alt="User avatar">

                <div>

                    <p><strong><span id="currentUserName"></span></strong></p>

                    <p>ID: <span id="currentUserId"></span></p>

                </div>

            </div>

            <div class="profile-upload">

                <label for="userProfileUpload">Update Profile Picture</label>

                <input type="file" id="userProfileUpload" accept="image/jpeg,image/png" aria-label="Update profile picture">

                <p id="userProfileUploadError" class="error-message"></p>

                <button id="updateProfileBtn">Upload</button>

            </div>

            <h3>Notification Settings</h3>

            <div class="settings-panel">

                <label>

                    <input type="checkbox" id="enableNotifications" aria-label="Enable notifications">

                    Enable Notifications

                </label>

            </div>

            <h3>Emergency Contacts</h3>

            <div class="emergency-contacts">

                <input type="text" id="contactName" placeholder="Contact Name" aria-label="Contact Name">

                <p id="contactNameError" class="error-message"></p>

                <input type="tel" id="contactPhone" placeholder="Phone Number" aria-label="Phone Number">

                <p id="contactPhoneError" class="error-message"></p>

                <button id="addContactBtn">Add Contact</button>

                <table>

                    <thead>

                        <tr>

                            <th>Name</th>

                            <th>Phone</th>

                            <th>Action</th>

                        </tr>

                    </thead>

                    <tbody id="emergencyContactsTable"></tbody>

                </table>

            </div>

            <h3>Emergency SOS</h3>

            <button class="sos-btn tooltip" id="sosBtn">

                SOS Alert

                <span class="tooltiptext">Send urgent alert to nearest ambulance</span>

            </button>

            <h3>Find Nearest Ambulance</h3>

            <select id="ambulanceTypeFilter" aria-label="Filter ambulance type">

                <option value="All">All Types</option>

                <option value="Basic">Basic</option>

                <option value="Advanced">Advanced</option>

                <option value="ICU">ICU</option>

            </select>

            <button class="tooltip" id="findAmbulanceBtn">

                Connect to Nearest Ambulance

                <span class="tooltiptext">Find the closest available ambulance</span>

            </button>

            <div id="bookingDetails" class="booking-card hidden"></div>

            <h3>Share Live Location</h3>

            <button id="toggleLocationBtn">Start Sharing Location</button>

            <h3>Chat with Driver</h3>

            <div id="chatContainer" class="chat-container hidden">

                <div id="chatMessages"></div>

                <textarea id="chatText" placeholder="Type a message..." rows="2" aria-label="Chat message"></textarea>

                <button id="sendChatBtn">Send</button>

            </div>

            <h3>Send Message to Driver</h3>

            <select id="messageDriverId" aria-label="Select driver">

                <option value="">Select Driver</option>

            </select>

            <p id="messageDriverIdError" class="error-message"></p>

            <textarea id="messageText" placeholder="Enter your message" rows="4" aria-label="Message"></textarea>

            <p id="messageError" class="error-message"></p>

            <button id="sendMessageBtn">Send Message</button>

            <h3>Booking History</h3>

            <div id="bookingHistory" class="booking-card">

                <table>

                    <thead>

                        <tr>

                            <th>Ambulance ID</th>

                            <th>Type</th>

                            <th>Timestamp</th>

                            <th>Status</th>

                        </tr>

                    </thead>

                    <tbody id="bookingHistoryTable"></tbody>

                </table>

            </div>

            <h3>Submit Feedback</h3>

            <textarea id="feedbackText" placeholder="Enter your feedback" rows="5" aria-label="Feedback"></textarea>

            <div class="rating">

                <input type="radio" id="star5" name="rating" value="5"><label for="star5">★</label>

                <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>

                <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>

                <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>

                <input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label>

            </div>

            <p id="feedbackError" class="error-message"></p>

            <button id="submitFeedbackBtn">Submit Feedback</button>

            <button id="userLogoutBtn">Logout</button>

        </div>

        <div id="driverSection" class="form-container hidden">

            <h2>Driver Dashboard</h2>

            <div class="profile-card">

                <img id="driverProfilePic" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRF////AAAAVcLTfgAAAAF0Uk5TAEDm2GYAAAATSURBVHjaYmAYBaNgFIyCUTAKAAQYACZ1A+U3AAAAAElFTkSuQmCC" alt="Driver avatar">

                <div>

                    <p><strong><span id="currentDriverName"></span></strong></p>

                    <p>ID: <span id="currentDriverId"></span></p>

                    <p>Status: <span id="driverAvailability" class="status-available">Available</span></p>

                    <p>Type: <span id="driverAmbulanceType"></span></p>

                    <p>Rating: <span id="driverRating">N/A</span></p>

                </div>

            </div>

            <div class="profile-upload">

                <label for="driverProfileUpload">Update Profile Picture</label>

                <input type="file" id="driverProfileUpload" accept="image/jpeg,image/png" aria-label="Update profile picture">

                <p id="driverProfileUploadError" class="error-message"></p>

                <button id="updateDriverProfileBtn">Upload</button>

            </div>

            <button id="toggleAvailabilityBtn">Toggle Availability</button>

            <button id="startTrackBtn">Start Tracking</button>

            <button id="stopTrackBtn" disabled>Stop Tracking</button>

            <h3>User Location</h3>

            <div id="driverMap" class="hidden"></div>

            <h3>Messages from Users</h3>

            <div id="driverMessages" class="message-inbox">

                <table>

                    <thead>

                        <tr>

                            <th>User ID</th>

                            <th>Message</th>

                            <th>Timestamp</th>

                        </tr>

                    </thead>

                    <tbody id="driverMessagesTable"></tbody>

                </table>

            </div>

            <h3>Chat with User</h3>

            <div id="driverChatContainer" class="chat-container hidden">

                <div id="driverChatMessages"></div>

                <textarea id="driverChatText" placeholder="Type a message..." rows="2" aria-label="Chat message"></textarea>

                <button id="sendDriverChatBtn">Send</button>

            </div>

            <button id="driverLogoutBtn">Logout</button>

        </div>

        <div id="adminSection" class="admin-container hidden">

            <h2>Admin Panel</h2>

            <div class="profile-card">

                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRF////AAAAVcLTfgAAAAF0Uk5TAEDm2GYAAAATSURBVHjaYmAYBaNgFIyCUTAKAAQYACZ1A+U3AAAAAElFTkSuQmCC" alt="Admin avatar">

                <div>

                    <p><strong>Admin</strong></p>

                    <p>ID: ADMIN</p>

                </div>

            </div>

            <div class="admin-panel">

                <h3>Analytics</h3>

                <p>Active Drivers: <span id="activeDrivers">0</span> | Total Feedback: <span id="totalFeedback">0</span> | Total Messages: <span id="totalMessages">0</span> | Total Chats: <span id="totalChats">0</span></p>

            </div>

            <h3>Pending Driver Registrations</h3>

            <div id="pendingDrivers" class="admin-panel">

                <table>

                    <thead>

                        <tr>

                            <th>Driver Name</th>

                            <th>Driver ID</th>

                            <th>Type</th>

                            <th>Action</th>

                        </tr>

                    </thead>

                    <tbody id="pendingTable"></tbody>

                </table>

            </div>

            <h3>Approved Drivers</h3>

            <div id="adminPanel" class="admin-panel">

                <table>

                    <thead>

                        <tr>

                            <th>Driver Name</th>

                            <th>Driver ID</th>

                            <th>Type</th>

                            <th>Status</th>

                            <th>Availability</th>

                            <th>Rating</th>

                            <th>Action</th>

                        </tr>

                    </thead>

                    <tbody id="adminTable"></tbody>

                </table>

            </div>

            <h3>Location History</h3>

            <div id="locationHistory" class="location-history">

                <button class="tooltip" id="exportHistoryBtn">

                    Export History (CSV)

                    <span class="tooltiptext">Download location data</span>

                </button>

                <table>

                    <thead>

                        <tr>

                            <th>Driver ID</th>

                            <th>Latitude</th>

                            <th>Longitude</th>

                            <th>Timestamp</th>

                        </tr>

                    </thead>

                    <tbody id="historyTable"></tbody>

                </table>

            </div>

            <h3>User Feedback</h3>

            <div id="feedbackPanel" class="feedback-panel">

                <table>

                    <thead>

                        <tr>

                            <th>User ID</th>

                            <th>Driver ID</th>

                            <th>Feedback</th>

                            <th>Rating</th>

                            <th>Timestamp</th>

                        </tr>

                    </thead>

                    <tbody id="feedbackTable"></tbody>

                </table>

            </div>

            <h3>User-Driver Messages</h3>

            <div id="messagePanel" class="message-inbox">

                <table>

                    <thead>

                        <tr>

                            <th>User ID</th>

                            <th>Driver ID</th>

                            <th>Message</th>

                            <th>Timestamp</th>

                        </tr>

                    </thead>

                    <tbody id="messageTable"></tbody>

                </table>

            </div>

            <h3>User-Driver Chats</h3>

            <div id="chatPanel" class="chat-container">

                <table>

                    <thead>

                        <tr>

                            <th>User ID</th>

                            <th>Driver ID</th>

                            <th>Message</th>

                            <th>Timestamp</th>

                        </tr>

                    </thead>

                    <tbody id="chatTable"></tbody>

                </table>

            </div>

            <button id="adminLogoutBtn">Logout</button>

        </div>

        <div id="trackerSection" class="form-container hidden">

            <h2>Track Ambulance</h2>

            <div class="form-grid">

                <input type="text" id="trackId" placeholder="Enter Ambulance ID (e.g., AMB001)" aria-label="Ambulance ID">

                <p id="trackIdError" class="error-message"></p>

                <div>

                    <button id="trackBtn">Track</button>

                    <button class="emergency-btn" id="callEmergencyBtn">Emergency Contact</button>

                </div>

            </div>

            <div class="map-controls">

                <button id="zoomUserBtn" disabled>Zoom to User</button>

                <button id="zoomAmbulanceBtn" disabled>Zoom to Ambulance</button>

                <select id="routeType" aria-label="Select route type">

                    <option value="fastest">Fastest Route</option>

                    <option value="shortest">Shortest Route</option>

                </select>

                <label class="live-toggle">

                    <input type="checkbox" id="liveTracking"> Live Tracking

                </label>

                <label class="live-toggle">

                    <input type="checkbox" id="weatherOverlay"> Show Weather

                </label>

            </div>

            <div id="distanceInfo" class="distance-info hidden"></div>

            <div id="map"></div>

            <div id="driverInfo" class="driver-info hidden"></div>

        </div>

        <div id="dashboardSection" class="dashboard-container hidden">

            <h2>Active Ambulances</h2>

            <div id="dashboard" class="dashboard">

                <table>

                    <thead>

                        <tr>

                            <th>Driver Name</th>

                            <th>Ambulance ID</th>

                            <th>Type</th>

                            <th>Latitude</th>

                            <th>Longitude</th>

                            <th>Last Updated</th>

                            <th>Status</th>

                            <th>Availability</th>

                            <th>Rating</th>

                            <th>Action</th>

                        </tr>

                    </thead>

                    <tbody id="dashboardTable"></tbody>

                </table>

            </div>

        </div>

    </div>

    <div id="modal" class="modal" role="dialog" aria-labelledby="modalMessage" tabindex="-1">

        <div class="modal-content" role="document">

            <p id="modalMessage" aria-live="assertive"></p>

            <button id="modalCloseBtn" aria-label="Close modal">OK</button>

            <div id="modalActions" class="hidden">

                <button id="confirmBookingBtn" class="tooltip">

                    Confirm Booking

                    <span class="tooltiptext">Book this ambulance</span>

                </button>

                <button id="cancelBookingBtn" aria-label="Cancel booking">Cancel</button>

            </div>

        </div>

    </div>

    <div id="notification" class="notification" aria-live="polite">

        <span id="notificationIcon" class="icon"></span>

        <p id="notificationMessage"></p>

        <span class="close-btn" id="closeNotificationBtn">×</span>

    </div>



    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

    <script>

        // Initialize localStorage

        let drivers = JSON.parse(localStorage.getItem('drivers')) || {};

        let pendingDrivers = JSON.parse(localStorage.getItem('pendingDrivers')) || {};

        let users = JSON.parse(localStorage.getItem('users')) || {};

        let trackingData = JSON.parse(localStorage.getItem('trackingData')) || {};

        let locationHistory = JSON.parse(localStorage.getItem('locationHistory')) || {};

        let feedbackData = JSON.parse(localStorage.getItem('feedbackData')) || [];

        let driverAvailability = JSON.parse(localStorage.getItem('driverAvailability')) || {};

        let mapSettings = JSON.parse(localStorage.getItem('mapSettings')) || { routeType: 'fastest', zoom: 13 };

        let bookingHistory = JSON.parse(localStorage.getItem('bookingHistory')) || {};

        let messages = JSON.parse(localStorage.getItem('messages')) || [];

        let chats = JSON.parse(localStorage.getItem('chatHistory')) || [];

        let userLocations = JSON.parse(localStorage.getItem('userLocations')) || {};

        let notificationSettings = JSON.parse(localStorage.getItem('notificationSettings')) || { enabled: true };

        const adminCredentials = { username: 'ADMIN', password: 'admin123' };

        let watchId = null;

        let map = null;

        let driverMap = null;

        let ambulanceMarker = null;

        let userMarker = null;

        let userLocation = null;

        let routeControl = null;

        let weatherLayer = null;

        let isLoggedIn = false;

        let loggedInType = null;

        let loggedInId = null;

        let loggedInName = null;

        let liveTrackingInterval = null;

        let nearestAmbulance = null;

        let locationSharingInterval = null;



        // Default placeholder image (1x1 gray pixel)

        const defaultProfilePic = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAAZQTFRF////AAAAVcLTfgAAAAF0Uk5TAEDm2GYAAAATSURBVHjaYmAYBaNgFIyCUTAKAAQYACZ1A+U3AAAAAElFTkSuQmCC';



        // Simulated weather data

        const weatherData = {

            'rain': { icon: '🌧️', desc: 'Rain may delay travel.' },

            'clear': { icon: '☀️', desc: 'Clear conditions.' },

            'clouds': { icon: '☁️', desc: 'Cloudy, no major impact.' }

        };



        // Error logging

        function logError(message, error) {

            console.error(`[${new Date().toISOString()}] ${message}`, error);

            if (notificationSettings.enabled) {

                showNotification(`Error: ${message}. Check console.`, 'error', '⚠️');

            } else {

                showModal(`Error: ${message}. Check console.`);

            }

        }



        // Validate input

        function validateInput(id, value, fieldName) {

            const errorElement = document.getElementById(`${id}Error`);

            if (!value.trim()) {

                if (errorElement) {

                    errorElement.textContent = `${fieldName} is required.`;

                    errorElement.style.display = 'block';

                } else {

                    console.warn(`Error element ${id}Error not found`);

                }

                return false;

            }

            if (errorElement) {

                errorElement.style.display = 'none';

            }

            return true;

        }



        // Validate image

        function validateImage(file, errorId, maxSizeKB = 500) {

            const errorElement = document.getElementById(errorId);

            if (!file) {

                if (errorElement) {

                    errorElement.textContent = 'Please select an image.';

                    errorElement.style.display = 'block';

                }

                return false;

            }

            if (!['image/jpeg', 'image/png'].includes(file.type)) {

                if (errorElement) {

                    errorElement.textContent = 'Only JPEG or PNG allowed.';

                    errorElement.style.display = 'block';

                }

                return false;

            }

            if (file.size > maxSizeKB * 1024) {

                if (errorElement) {

                    errorElement.textContent = `Image must be under ${maxSizeKB}KB.`;

                    errorElement.style.display = 'block';

                }

                return false;

            }

            if (errorElement) {

                errorElement.style.display = 'none';

            }

            return true;

        }



        // Initialize maps

        function initMap(lat = 0, lng = 0, mapId = 'map') {

            try {

                const targetMap = mapId === 'map' ? map : driverMap;

                if (targetMap) {

                    targetMap.off();

                    targetMap.remove();

                }

                const newMap = L.map(mapId, { scrollWheelZoom: false }).setView([lat, lng], mapSettings.zoom);

                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {

                    attribution: '© OpenStreetMap, © CartoDB'

                }).addTo(newMap);

                newMap.whenReady(() => {

                    newMap.scrollWheelZoom.enable();

                });

                if (mapId === 'map') {

                    map = newMap;

                    if (!ambulanceMarker) {

                        ambulanceMarker = L.marker([lat, lng], {

                            icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41] })

                        }).addTo(map);

                    }

                    document.getElementById('zoomAmbulanceBtn').disabled = false;

                } else {

                    driverMap = newMap;

                }

                newMap.on('zoomend', () => {

                    mapSettings.zoom = newMap.getZoom();

                    localStorage.setItem('mapSettings', JSON.stringify(mapSettings));

                });

            } catch (error) {

                logError(`Map initialization failed for ${mapId}`, error);

            }

        }



        // Toggle weather overlay

        function toggleWeatherOverlay() {

            try {

                const isChecked = document.getElementById('weatherOverlay').checked;

                if (isChecked && map) {

                    if (!weatherLayer) {

                        weatherLayer = L.tileLayer('https://{s}.tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=fakekey', {

                            opacity: 0.5

                        }).addTo(map);

                        showNotification('Weather overlay enabled: Clear conditions.', 'info', weatherData.clear.icon);

                    }

                } else if (weatherLayer && map) {

                    map.removeLayer(weatherLayer);

                    weatherLayer = null;

                    showNotification('Weather overlay disabled.', 'info', 'ℹ️');

                }

            } catch (error) {

                logError('Toggle weather overlay failed', error);

            }

        }



        // Show section

        function showSection(sectionId) {

            try {

                const sections = ['homeSection', 'loginSection', 'userSection', 'driverSection', 'adminSection', 'trackerSection', 'dashboardSection'];

                sections.forEach(id => {

                    const section = document.getElementById(id);

                    if (section) section.classList.add('hidden');

                });

                const sectionElement = document.getElementById(sectionId);

                if (sectionElement) {

                    sectionElement.classList.remove('hidden');

                    if (sectionId === 'trackerSection') {

                        const trackId = document.getElementById('trackId').value;

                        if (trackId && trackingData[trackId]) trackAmbulance();

                        document.getElementById('routeType').value = mapSettings.routeType;

                    }

                    if (sectionId === 'dashboardSection') updateDashboard();

                    if (sectionId === 'adminSection') updateAdminPanel();

                    if (sectionId === 'userSection') {

                        updateBookingHistory();

                        updateMessageDriverList();

                        updateChat();

                        updateEmergencyContacts();

                        document.getElementById('enableNotifications').checked = notificationSettings.enabled;

                    }

                    if (sectionId === 'driverSection') {

                        updateDriverMessages();

                        updateDriverMap();

                        updateDriverChat();

                    }

                }

                toggleMenu(false);

            } catch (error) {

                logError('Section switch failed', error);

            }

        }



        // Toggle mobile menu

        function toggleMenu(force = null) {

            const menu = document.getElementById('navMenu');

            if (force !== null) {

                menu.classList.toggle('active', force);

            } else {

                menu.classList.toggle('active');

            }

        }



        // Show modal

        function showModal(message, actions = false) {

            const modal = document.getElementById('modal');

            const modalMessage = document.getElementById('modalMessage');

            const modalActions = document.getElementById('modalActions');

            const closeBtn = document.getElementById('modalCloseBtn');

            if (!modal || !modalMessage || !modalActions || !closeBtn) {

                console.error('Modal elements not found');

                return;

            }

            modalMessage.textContent = message;

            modalActions.classList.toggle('hidden', !actions);

            modal.style.display = 'flex';

            closeBtn.focus();



            const focusableElements = modal.querySelectorAll('button');

            const firstElement = focusableElements[0];

            const lastElement = focusableElements[focusableElements.length - 1];



            modal.addEventListener('keydown', function trapFocus(e) {

                if (e.key === 'Tab') {

                    if (e.shiftKey) {

                        if (document.activeElement === firstElement) {

                            e.preventDefault();

                            lastElement.focus();

                        }

                    } else {

                        if (document.activeElement === lastElement) {

                            e.preventDefault();

                            firstElement.focus();

                        }

                    }

                }

                if (e.key === 'Escape') closeModal();

            }, { once: true });

        }



        // Close modal

        function closeModal() {

            const modal = document.getElementById('modal');

            if (modal) {

                modal.style.display = 'none';

                document.getElementById('modalActions').classList.add('hidden');

                nearestAmbulance = null;

            }

        }



        // Show notification

        function showNotification(message, type = 'info', icon = 'ℹ️') {

            if (!notificationSettings.enabled) return;

            const notification = document.getElementById('notification');

            const messageElement = document.getElementById('notificationMessage');

            const iconElement = document.getElementById('notificationIcon');

            if (!notification || !messageElement || !iconElement) return;

            messageElement.textContent = message;

            iconElement.textContent = icon;

            notification.classList.remove('success', 'error');

            if (type === 'success') notification.classList.add('success');

            else if (type === 'error') notification.classList.add('error');

            notification.style.display = 'flex';

            setTimeout(hideNotification, 5000);

        }



        // Hide notification

        function hideNotification() {

            const notification = document.getElementById('notification');

            if (notification) notification.style.display = 'none';

        }



        // Toggle notifications

        function toggleNotifications() {

            notificationSettings.enabled = document.getElementById('enableNotifications').checked;

            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));

            showNotification(`Notifications ${notificationSettings.enabled ? 'enabled' : 'disabled'}.`, 'success', '✅');

        }



        // Update navbar

        function updateNavbar() {

            try {

                const accountName = document.getElementById('accountName');

                const accountDetails = document.getElementById('accountDetails');

                const logoutLink = document.getElementById('logoutLink');

                if (isLoggedIn) {

                    accountName.textContent = loggedInName || 'Account';

                    accountDetails.textContent = loggedInId ? `ID: ${loggedInId}` : '';

                    logoutLink.style.display = 'block';

                    accountName.onclick = null;

                } else {

                    accountName.textContent = 'Account';

                    accountDetails.textContent = '';

                    logoutLink.style.display = 'none';

                    accountName.onclick = () => showSection('loginSection');

                }

            } catch (error) {

                logError('Nav update failed', error);

            }

        }



        // Toggle login fields

        function toggleLoginFields() {

            try {

                const accountType = document.getElementById('accountType').value;

                const registerFields = document.getElementById('registerFields');

                const ambulanceTypeField = document.getElementById('regAmbulanceType');

                const profilePicField = document.getElementById('regProfilePic');

                registerFields.classList.toggle('hidden', accountType === 'admin');

                ambulanceTypeField.classList.toggle('hidden', accountType !== 'driver');

                profilePicField.classList.toggle('hidden', accountType === 'admin');

            } catch (error) {

                logError('Toggle login fields failed', error);

            }

        }



        // Calculate distance

        function calculateDistance(lat1, lon1, lat2, lon2) {

            try {

                const R = 6371;

                const dLat = (lat2 - lat1) * Math.PI / 180;

                const dLon = (lon2 - lon1) * Math.PI / 180;

                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +

                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *

                          Math.sin(dLon / 2) * Math.sin(dLon / 2);

                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

                return (R * c).toFixed(2);

            } catch (error) {

                logError('Distance calculation failed', error);

                return 0;

            }

        }



        // Estimate ETA

        function estimateETA(distance) {

            try {

                const speed = 40;

                const hours = distance / speed;

                const minutes = Math.ceil(hours * 60);

                return minutes > 0 ? `${minutes} min` : '<1 min';

            } catch (error) {

                logError('ETA calculation failed', error);

                return 'N/A';

            }

        }



        // Get user location

        function getUserLocation(callback) {

            if (!navigator.geolocation) {

                showModal('Geolocation not supported by your browser.');

                callback(null);

                return;

            }

            navigator.geolocation.getCurrentPosition(

                position => {

                    userLocation = {

                        latitude: position.coords.latitude,

                        longitude: position.coords.longitude,

                    };

                    callback(userLocation);

                    document.getElementById('zoomUserBtn').disabled = false;

                },

                error => {

                    let message = 'Failed to fetch location.';

                    if (error.code === 1) message = 'Location access denied. Please enable location services.';

                    else if (error.code === 3) message = 'Location request timed out. Please check your network.';

                    logError('User location fetch failed', error);

                    showModal(message);

                    callback(null);

                },

                { enableHighAccuracy: true, timeout: 15000 }

            );

        }



        // Update profile picture

        async function updateProfilePic(event) {

            const button = event.target;

            if (!button) return;

            try {

                button.classList.add('loading');

                const fileInput = document.getElementById('userProfileUpload');

                const file = fileInput.files[0];

                if (!validateImage(file, 'userProfileUploadError')) return;



                const reader = new FileReader();

                reader.onload = () => {

                    users[loggedInId].profilePic = reader.result;

                    localStorage.setItem('users', JSON.stringify(users));

                    document.getElementById('userProfilePic').src = reader.result;

                    showNotification('Profile picture updated.', 'success', '✅');

                };

                reader.onerror = () => {

                    showNotification('Failed to load profile picture.', 'error', '❌');

                };

                reader.readAsDataURL(file);

            } catch (error) {

                logError('Profile picture update failed', error);

            } finally {

                button.classList.remove('loading');

            }

        }



        // Update driver profile picture

        async function updateDriverProfilePic(event) {

            const button = event.target;

            if (!button) return;

            try {

                button.classList.add('loading');

                const fileInput = document.getElementById('driverProfileUpload');

                const file = fileInput.files[0];

                if (!validateImage(file, 'driverProfileUploadError')) return;



                const reader = new FileReader();

                reader.onload = () => {

                    drivers[loggedInId].profilePic = reader.result;

                    localStorage.setItem('drivers', JSON.stringify(drivers));

                    document.getElementById('driverProfilePic').src = reader.result;

                    showNotification('Profile picture updated.', 'success', '✅');

                };

                reader.onerror = () => {

                    showNotification('Failed to load profile picture.', 'error', '❌');

                };

                reader.readAsDataURL(file);

            } catch (error) {

                logError('Driver profile picture update failed', error);

            } finally {

                button.classList.remove('loading');

            }

        }



        // Add emergency contact

        async function addEmergencyContact(event) {

            const button = event.target;

            if (!button) return;

            try {

                button.classList.add('loading');

                const name = document.getElementById('contactName').value.trim();

                const phone = document.getElementById('contactPhone').value.trim();

                if (!validateInput('contactName', name, 'Contact Name') ||

                    !validateInput('contactPhone', phone, 'Phone Number')) return;



                if (!users[loggedInId].emergencyContacts) users[loggedInId].emergencyContacts = [];

                users[loggedInId].emergencyContacts.push({ name, phone });

                if (users[loggedInId].emergencyContacts.length > 5) users[loggedInId].emergencyContacts.shift();

                localStorage.setItem('users', JSON.stringify(users));

                document.getElementById('contactName').value = '';

                document.getElementById('contactPhone').value = '';

                updateEmergencyContacts();

                showNotification('Emergency contact added.', 'success', '✅');

            } catch (error) {

                logError('Add emergency contact failed', error);

            } finally {

                button.classList.remove('loading');

            }

        }



        // Update emergency contacts

        function updateEmergencyContacts() {

            try {

                const tbody = document.getElementById('emergencyContactsTable');

                tbody.innerHTML = '';

                const contacts = users[loggedInId]?.emergencyContacts || [];

                contacts.forEach((contact, index) => {

                    const row = document.createElement('tr');

                    row.innerHTML = `

                        <td>${contact.name}</td>

                        <td>${contact.phone}</td>

                        <td><button class="delete-contact-btn" data-index="${index}">Delete</button></td>

                    `;

                    tbody.appendChild(row);

                });

                document.querySelectorAll('.delete-contact-btn').forEach(btn => {

                    btn.addEventListener('click', () => deleteEmergencyContact(parseInt(btn.dataset.index)));

                });

            } catch (error) {

                logError('Update emergency contacts failed', error);

            }

        }



        // Delete emergency contact

        function deleteEmergencyContact(index) {

            try {

                users[loggedInId].emergencyContacts.splice(index, 1);

                localStorage.setItem('users', JSON.stringify(users));

                updateEmergencyContacts();

                showNotification('Emergency contact deleted.', 'success', '✅');

            } catch (error) {

                logError('Delete emergency contact failed', error);

            }

        }



        // Send SOS

        async function sendSOS(event) {

            const button = event.target;

            if (!button) return;

            try {

                button.classList.add('loading');

                if (!isLoggedIn || loggedInType !== 'user') {

                    showModal('Please log in as a user.');

                    return;

                }

                await findNearestAmbulance(true);

                messages.push({

                    userId: loggedInId,

                    driverId: nearestAmbulance?.id || 'ALL',

                    message: 'Urgent: Immediate assistance needed!',

                    timestamp: new Date().toISOString()

                });

                if (messages.length > 50) messages.shift();

                localStorage.setItem('messages', JSON.stringify(messages));

                updateDriverMessages();

                updateAdminPanel();

                const contacts = users[loggedInId]?.emergencyContacts || [];

                contacts.forEach(contact => {

                    showNotification(`Simulated SOS call to ${contact.name} (${contact.phone}).`, 'success', '📞');

                });

                showNotification('SOS alert sent to nearest ambulance.', 'success', '🚨');

            } catch (error) {

                logError('SOS failed', error);

            } finally {

                button.classList.remove('loading');

            }

        }



        // Find nearest ambulance

        async function findNearestAmbulance(isAuto = false) {

            const button = event?.target;

            try {

                if (button) button.classList.add('loading');

                if (!isLoggedIn || loggedInType !== 'user') {

                    showModal('Please log in as a user.');

                    return;

                }



                const ambulanceType = document.getElementById('ambulanceTypeFilter').value;



                getUserLocation(userLoc => {

                    if (!userLoc) return;



                    let nearest = null;

                    let minDistance = Infinity;

                    Object.entries(trackingData).forEach(([id, data]) => {

                        if (driverAvailability[id] === 'Available' && data.latitude && data.longitude &&

                            (ambulanceType === 'All' || drivers[id]?.ambulanceType === ambulanceType)) {

                            const distance = calculateDistance(

                                userLoc.latitude, userLoc.longitude,

                                data.latitude, data.longitude

                            );

                            if (distance < minDistance) {

                                minDistance = distance;

                                nearest = { id, data, distance };

                            }

                        }

                    });



                    if (!nearest) {

                        showModal('No available ambulances found.');

                        return;

                    }



                    const eta = estimateETA(nearest.distance);

                    nearestAmbulance = { ...nearest, eta };

                    const avgRating = calculateDriverRating(nearest.id);

                    const bookingDetails = document.getElementById('bookingDetails');

                    bookingDetails.innerHTML = `

                        <div>

                            <h4>Ambulance Details</h4>

                            <p><strong>Driver:</strong> ${nearest.data.name || 'N/A'}</p>

                            <p><strong>ID:</strong> ${nearest.id}</p>

                            <p><strong>Type:</strong> ${drivers[nearest.id]?.ambulanceType || 'N/A'}</p>

                            <p><strong>Distance:</strong> ${nearest.distance} km</p>

                            <p><strong>ETA:</strong> ${eta}</p>

                            <p><strong>Rating:</strong> ${avgRating ? avgRating.toFixed(1) + ' ★' : 'No ratings'}</p>

                        </div>

                        <div>

                            <button class="call-btn tooltip" onclick="callAmbulance('${nearest.id}')">

                                Call Driver

                                <span class="tooltiptext">Contact the driver</span>

                            </button>

                        </div>

                    `;

                    bookingDetails.classList.remove('hidden');

                    if (!isAuto) {

                        showModal(`Nearest ambulance found: ${nearest.id} (${nearest.distance} km, ETA: ${eta}). Confirm booking?`, true);

                    }

                });

            } catch (error) {

                logError('Find nearest ambulance failed', error);

            } finally {

                if (button) button.classList.remove('loading');

            }

        }



        // Confirm booking

        async function confirmBooking() {

            const button = document.getElementById('confirmBookingBtn');

            if (!button) return;

            try {

                button.classList.add('loading');

                if (!nearestAmbulance) {

                    showModal('No ambulance selected.');

                    return;

                }



                const userId = loggedInId;

                const ambulanceId = nearestAmbulance.id;

                const timestamp = new Date().toISOString();

                if (!bookingHistory[userId]) bookingHistory[userId] = [];

                bookingHistory[userId].push({

                    ambulanceId,

                    ambulanceType: drivers[ambulanceId]?.ambulanceType || 'N/A',

                    timestamp,

                    status: 'Confirmed'

                });

                if (bookingHistory[userId].length > 50) bookingHistory[userId].shift();

                localStorage.setItem('bookingHistory', JSON.stringify(bookingHistory));

                updateBooking();

                updateChat();

                showModal(`Ambulance ${ambulanceId} booked successfully!`);

                document.getElementById('trackId').value = ambulanceId;

                showSection('trackerSection');

                await trackAmbulance();

            } catch (error) {

                logError('Confirm booking failed', error);

            } finally {

                button.classList.remove('loading');

            }

        }



        // Call ambulance

        async function callAmbulance(driverId) {

            const button = event?.target;

            if (!button) return;

            try {

                button.classList.add('loading');

                if (!isLoggedIn) {

                    showModal('Please log in to make a call.');

                    return;

                }

                showNotification(`Simulated call to driver ${driverId}.`, 'success', '📞');

            } catch (error) {

                logError('Call ambulance failed', error);

            } finally {

                button.classList.remove('loading');

            }

        }



        // Toggle location sharing

        async function toggleLocationSharing(event) {

            const button = event.target;

            if (!button) return;

            try {

                button.classList.add('loading');

                if (!isLoggedIn || loggedInType !== 'user') {

                    showModal('Please log in as a user.');

                    return;

                }

                if (locationSharingInterval) {

                    clearInterval(locationSharingInterval);

                    locationSharingInterval = null;

                    delete userLocations[loggedInId];

                    localStorage.setItem('userLocations', JSON.stringify(userLocations));

                    button.textContent = 'Start Sharing Location';

                    showNotification('Location sharing stopped.', 'info', 'ℹ️');

                } else {

                    getUserLocation(userLoc => {

                        if (!userLoc) return;

                        userLocations[loggedInId] = {

                            latitude: userLoc.latitude,

                            longitude: userLoc.longitude,

                            timestamp: new Date().toISOString()

                        };

                        localStorage.setItem('userLocations', JSON.stringify(userLocations));

                        locationSharingInterval = setInterval(() => {

                            getUserLocation(loc => {

                                if (loc) {

                                    userLocations[loggedInId] = {

                                        latitude: loc.latitude,

                                        longitude: loc.longitude,

                                        timestamp: new Date().toISOString()

                                    };

                                    localStorage.setItem('userLocations', JSON.stringify(userLocations));

                                }

                            });

                        }, 10000);

                        button.textContent = 'Stop Sharing Location';

                        showNotification('Location sharing started.', 'success', '📍');

                    });

                }

            } catch (error) {

                logError('Toggle location sharing failed', error);

            } finally {

                button.classList.remove('loading');

            }

        }



        // Send message

        async function sendMessage(event) {

            const button = event.target;

            if (!button) return;

            try {

                button.classList.add('loading');

                const driverId = document.getElementById('messageDriverId').value;

                const messageText = document.getElementById('messageText').value.trim();



                if (!validateInput('messageDriverId', driverId, 'Driver ID') ||

                    !validateInput('messageText', messageText, 'Message')) return;



                if (!drivers[driverId]) {

                    showModal('Invalid driver ID.');

                    return;

                }



                messages.push({

                    userId: loggedInId,

                    driverId,

                    message: messageText,

                    timestamp: new Date().toISOString()

                });

                if (messages.length > 50) messages.shift();

                localStorage.setItem('messages', JSON.stringify(messages));

                document.getElementById('messageText').value = '';

                document.getElementById('messageError').style.display = 'none';

                updateDriverMessages();

                if (loggedInType === 'admin') updateAdminPanel();

                showNotification('Message sent successfully.', 'success', '✉️');

            } catch (error) {

                logError('Send message failed', error);

            } finally {

                button.classList.remove('loading');

            }

        }



        // Send chat message

        async function sendChatMessage(event) {

            const button = event.target;

            if (!button) return;

            try {

                button.classList.add('loading');

                const messageText = document.getElementById('chatText').value.trim();

                const userId = loggedInId;

                const driverId = bookingHistory[userId]?.slice(-1)[0]?.ambulanceId;



                if (!driverId) {

                    showModal('No active booking found. Book an ambulance first.');

                    return;

                }



                if (!validateInput('chatText', messageText, 'Message')) return;



                chats.push({

                    userId,

                    driverId,

                    message: messageText,

                    sender: userId,

                    timestamp: new Date().toISOString()

                });

                if (chats.length > 50) chats.shift();

                localStorage.setItem('chatHistory', JSON.stringify(chats));

                document.getElementById('chatText').value = '';

                updateChat();

                updateDriverChat();

                updateAdminPanel();

                showNotification('Chat message sent.', 'success', '💬');

            } catch (error) {

                logError('Send chat message failed', error);

            } finally {

                button.classList.remove('loading');

            }

        }



        // Send driver chat message

        async function sendDriverChatMessage(event) {

            const button = event.target;

            if (!button) return;

            try {

                button.classList.add('loading');

                const messageText = document.getElementById('driverChatText').value.trim();

                const driverId = loggedInId;

                const userId = chats.find(chat => chat.driverId === driverId && chat.userId !== driverId)?.userId;



                if (!userId) {

                    showModal('No active chat with user.');

                    return;

                }



                if (!validateInput('driverChatText', messageText, 'Message')) return;



                chats.push({

                    userId,

                    driverId,

                    message: messageText,

                    sender: driverId,

                    timestamp: new Date().toISOString()

                });

                if (chats.length > 50) chats.shift();

                localStorage.setItem('chatHistory', JSON.stringify(chats));

                document.getElementById('driverChatText').value = '';

                updateChat();

                updateDriverChat();

                updateAdminPanel();

                showNotification('Chat message sent.', 'success', '💬');

            } catch (error) {

                logError('Send driver chat message failed', error);

            } finally {

                button.classList.remove('loading');

            }

        }



        // Update chat

        function updateChat() {

            try {

                const chatContainer = document.getElementById('chatContainer');

                const messagesDiv = document.getElementById('chatMessages');

                const userId = loggedInId;

                const driverId = bookingHistory[userId]?.slice(-1)[0]?.ambulanceId;



                if (!driverId) {

                    chatContainer.classList.add('hidden');

                    return;

                }



                chatContainer.classList.remove('hidden');

                messagesDiv.innerHTML = '';

                chats.filter(chat => chat.userId === userId && chat.driverId === driverId).forEach(msg => {

                    const msgDiv = document.createElement('div');

                    msgDiv.className = `chat-message ${msg.sender === userId ? 'sent' : 'received'}`;

                    msgDiv.textContent = `${msg.sender === userId ? 'You' : 'Driver'} : ${msg.message} (${new Date(msg.timestamp).toLocaleTimeString()})`;

                    messagesDiv.appendChild(msgDiv);

                });

                messagesDiv.scrollTop = messagesDiv.scrollHeight;

            } catch (error) {

                logError('Update chat failed', error);

            }

        }



        



    // Update driver chat

    function updateDriverChat() {

        try {

            const chatContainer = document.getElementById('driverChatContainer');

            const messagesDiv = document.getElementById('driverChatMessages');

            const driverId = loggedInId;

            const userId = chats.find(chat => chat.driverId === driverId && chat.userId !== driverId)?.userId;



            if (!userId) {

                chatContainer.classList.add('hidden');

                return;

            }



            chatContainer.classList.remove('hidden');

            messagesDiv.innerHTML = '';

            chats.filter(chat => chat.driverId === driverId && chat.userId === userId).forEach(msg => {

                const msgDiv = document.createElement('div');

                msgDiv.className = `chat-message ${msg.sender === driverId ? 'sent' : 'received'}`;

                msgDiv.textContent = `${msg.sender === driverId ? 'You' : 'User'} : ${msg.message} (${new Date(msg.timestamp).toLocaleTimeString()})`;

                messagesDiv.appendChild(msgDiv);

            });

            messagesDiv.scrollTop = messagesDiv.scrollHeight;

        } catch (error) {

            logError('Update driver chat failed', error);

        }

    }



    // Update driver messages

    function updateDriverMessages() {

        try {

            const tbody = document.getElementById('driverMessagesTable');

            tbody.innerHTML = '';

            messages.filter(msg => msg.driverId === loggedInId).forEach(msg => {

                const row = document.createElement('tr');

                row.innerHTML = `

                    <td>${msg.userId}</td>

                    <td>${msg.message}</td>

                    <td>${new Date(msg.timestamp).toLocaleString()}</td>

                `;

                tbody.appendChild(row);

            });

        } catch (error) {

            logError('Update driver messages failed', error);

        }

    }



    // Update booking history

    function updateBookingHistory() {

        try {

            const tbody = document.getElementById('bookingHistoryTable');

            tbody.innerHTML = '';

            const userBookings = bookingHistory[loggedInId] || [];

            userBookings.forEach(booking => {

                const row = document.createElement('tr');

                row.innerHTML = `

                    <td>${booking.ambulanceId}</td>

                    <td>${booking.ambulanceType}</td>

                    <td>${new Date(booking.timestamp).toLocaleString()}</td>

                    <td>${booking.status}</td>

                `;

                tbody.appendChild(row);

            });

        } catch (error) {

            logError('Update booking history failed', error);

        }

    }



    // Update message driver list

    function updateMessageDriverList() {

        try {

            const select = document.getElementById('messageDriverId');

            select.innerHTML = '<option value="">Select Driver</option>';

            Object.keys(drivers).forEach(id => {

                const option = document.createElement('option');

                option.value = id;

                option.textContent = `${id} (${drivers[id].name})`;

                select.appendChild(option);

            });

        } catch (error) {

            logError('Update message driver list failed', error);

        }

    }



    // Register account

    async function registerAccount(event) {

        const button = event.target;

        if (!button) return;

        try {

            button.classList.add('loading');

            const accountType = document.getElementById('accountType').value;

            const loginId = document.getElementById('loginId').value.trim();

            const password = document.getElementById('loginPassword').value;

            const name = document.getElementById('regName').value.trim();

            const profilePicInput = document.getElementById('regProfilePic');

            const ambulanceType = document.getElementById('regAmbulanceType').value;



            if (!validateInput('loginId', loginId, 'ID') ||

                !validateInput('loginPassword', password, 'Password')) return;



            if (accountType !== 'admin') {

                if (!validateInput('regName', name, 'Name')) return;

                if (profilePicInput.files.length && !validateImage(profilePicInput.files[0], 'regProfilePicError')) return;

            }



            if ((accountType === 'user' && users[loginId]) ||

                (accountType === 'driver' && (drivers[loginId] || pendingDrivers[loginId])) ||

                (accountType === 'admin' && loginId !== adminCredentials.username)) {

                showModal('ID already exists or invalid admin ID.');

                return;

            }



            let profilePic = defaultProfilePic;

            if (profilePicInput.files.length) {

                const reader = new FileReader();

                await new Promise(resolve => {

                    reader.onload = () => {

                        profilePic = reader.result;

                        resolve();

                    };

                    reader.readAsDataURL(profilePicInput.files[0]);

                });

            }



            if (accountType === 'user') {

                users[loginId] = { name, password, profilePic, emergencyContacts: [] };

                localStorage.setItem('users', JSON.stringify(users));

                showNotification('User registered successfully.', 'success', '✅');

            } else if (accountType === 'driver') {

                pendingDrivers[loginId] = { name, password, profilePic, ambulanceType };

                localStorage.setItem('pendingDrivers', JSON.stringify(pendingDrivers));

                showNotification('Driver registration submitted for approval.', 'success', '✅');

            } else {

                if (loginId === adminCredentials.username && password === adminCredentials.password) {

                    showNotification('Admin logged in.', 'success', '✅');

                } else {

                    showModal('Invalid admin credentials.');

                    return;

                }

            }



            document.getElementById('loginId').value = '';

            document.getElementById('loginPassword').value = '';

            document.getElementById('regName').value = '';

            profilePicInput.value = '';

        } catch (error) {

            logError('Registration failed', error);

        } finally {

            button.classList.remove('loading');

        }

    }



    // Login account

    async function loginAccount(event) {

        const button = event.target;

        if (!button) return;

        try {

            button.classList.add('loading');

            const accountType = document.getElementById('accountType').value;

            const loginId = document.getElementById('loginId').value.trim();

            const password = document.getElementById('loginPassword').value;



            if (!validateInput('loginId', loginId, 'ID') ||

                !validateInput('loginPassword', password, 'Password')) return;



            let success = false;

            if (accountType === 'user' && users[loginId] && users[loginId].password === password) {

                isLoggedIn = true;

                loggedInType = 'user';

                loggedInId = loginId;

                loggedInName = users[loginId].name;

                document.getElementById('currentUserId').textContent = loginId;

                document.getElementById('currentUserName').textContent = loggedInName;

                document.getElementById('userProfilePic').src = users[loginId].profilePic || defaultProfilePic;

                showSection('userSection');

                success = true;

            } else if (accountType === 'driver' && drivers[loginId] && drivers[loginId].password === password) {

                isLoggedIn = true;

                loggedInType = 'driver';

                loggedInId = loginId;

                loggedInName = drivers[loginId].name;

                document.getElementById('currentDriverId').textContent = loginId;

                document.getElementById('currentDriverName').textContent = loggedInName;

                document.getElementById('driverProfilePic').src = drivers[loginId].profilePic || defaultProfilePic;

                document.getElementById('driverAmbulanceType').textContent = drivers[loginId].ambulanceType || 'N/A';

                document.getElementById('driverAvailability').textContent = driverAvailability[loginId] || 'Available';

                document.getElementById('driverAvailability').className = driverAvailability[loginId] === 'Available' ? 'status-available' : 'status-busy';

                document.getElementById('driverRating').textContent = calculateDriverRating(loginId).toFixed(1) || 'N/A';

                showSection('driverSection');

                success = true;

            } else if (accountType === 'admin' && loginId === adminCredentials.username && password === adminCredentials.password) {

                isLoggedIn = true;

                loggedInType = 'admin';

                loggedInId = loginId;

                loggedInName = 'Admin';

                showSection('adminSection');

                success = true;

            }



            if (success) {

                updateNavbar();

                document.getElementById('loginId').value = '';

                document.getElementById('loginPassword').value = '';

                showNotification('Login successful.', 'success', '✅');

            } else {

                showModal('Invalid credentials or pending driver approval.');

            }

        } catch (error) {

            logError('Login failed', error);

        } finally {

            button.classList.remove('loading');

        }

    }



    // Logout

    function logout() {

        try {

            isLoggedIn = false;

            loggedInType = null;

            loggedInId = null;

            loggedInName = null;

            if (watchId) {

                navigator.geolocation.clearWatch(watchId);

                watchId = null;

            }

            if (liveTrackingInterval) {

                clearInterval(liveTrackingInterval);

                liveTrackingInterval = null;

            }

            if (locationSharingInterval) {

                clearInterval(locationSharingInterval);

                locationSharingInterval = null;

            }

            updateNavbar();

            showSection('homeSection');

            showNotification('Logged out successfully.', 'success', '✅');

        } catch (error) {

            logError('Logout failed', error);

        }

    }



    // Submit feedback

    async function submitFeedback(event) {

        const button = event.target;

        if (!button) return;

        try {

            button.classList.add('loading');

            const feedbackText = document.getElementById('feedbackText').value.trim();

            const rating = document.querySelector('input[name="rating"]:checked')?.value;

            const driverId = bookingHistory[loggedInId]?.slice(-1)[0]?.ambulanceId;



            if (!validateInput('feedbackText', feedbackText, 'Feedback') || !rating) {

                document.getElementById('feedbackError').textContent = 'Feedback and rating are required.';

                document.getElementById('feedbackError').style.display = 'block';

                return;

            }



            if (!driverId) {

                showModal('No recent booking found to provide feedback.');

                return;

            }



            feedbackData.push({

                userId: loggedInId,

                driverId,

                feedback: feedbackText,

                rating: parseInt(rating),

                timestamp: new Date().toISOString()

            });

            if (feedbackData.length > 50) feedbackData.shift();

            localStorage.setItem('feedbackData', JSON.stringify(feedbackData));

            document.getElementById('feedbackText').value = '';

            document.querySelectorAll('input[name="rating"]').forEach(r => r.checked = false);

            document.getElementById('feedbackError').style.display = 'none';

            updateAdminPanel();

            showNotification('Feedback submitted successfully.', 'success', '⭐');

        } catch (error) {

            logError('Feedback submission failed', error);

        } finally {

            button.classList.remove('loading');

        }

    }



    // Calculate driver rating

    function calculateDriverRating(driverId) {

        try {

            const ratings = feedbackData.filter(f => f.driverId === driverId).map(f => f.rating);

            return ratings.length ? ratings.reduce((a, b) => a + b, 0) / ratings.length : 0;

        } catch (error) {

            logError('Calculate driver rating failed', error);

            return 0;

        }

    }



    // Track ambulance

    async function trackAmbulance(event) {

        const button = event?.target;

        try {

            if (button) button.classList.add('loading');

            const trackId = document.getElementById('trackId').value.trim().toUpperCase();

            if (!validateInput('trackId', trackId, 'Ambulance ID')) return;



            if (!trackingData[trackId] || !drivers[trackId]) {

                showModal('Ambulance ID not found.');

                return;

            }



            getUserLocation(async userLoc => {

                if (!userLoc) return;



                if (!map) initMap(userLoc.latitude, userLoc.longitude);



                if (userMarker) map.removeLayer(userMarker);

                userMarker = L.marker([userLoc.latitude, userLoc.longitude], {

                    icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41] })

                }).addTo(map).bindPopup('Your Location').openPopup();



                const data = trackingData[trackId];

                if (ambulanceMarker) {

                    ambulanceMarker.setLatLng([data.latitude, data.longitude]);

                } else {

                    ambulanceMarker = L.marker([data.latitude, data.longitude], {

                        icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41] })

                    }).addTo(map);

                }

                ambulanceMarker.bindPopup(`Ambulance ${trackId}`).openPopup();



                const distance = calculateDistance(userLoc.latitude, userLoc.longitude, data.latitude, data.longitude);

                const eta = estimateETA(distance);

                document.getElementById('distanceInfo').innerHTML = `

                    <p><strong>Distance:</strong> ${distance} km</p>

                    <p><strong>ETA:</strong> ${eta}</p>

                    <p><strong>Last Updated:</strong> ${new Date(data.timestamp).toLocaleString()}</p>

                `;

                document.getElementById('distanceInfo').classList.remove('hidden');



                document.getElementById('driverInfo').innerHTML = `

                    <p><strong>Driver:</strong> ${data.name || 'N/A'}</p>

                    <p><strong>Ambulance ID:</strong> ${trackId}</p>

                    <p><strong>Type:</strong> ${drivers[trackId].ambulanceType || 'N/A'}</p>

                    <p><strong>Availability:</strong> <span class="${driverAvailability[trackId] === 'Available' ? 'status-available' : 'status-busy'}">${driverAvailability[trackId] || 'Unknown'}</span></p>

                    <p><strong>Rating:</strong> ${calculateDriverRating(trackId).toFixed(1) || 'N/A'} ★</p>

                `;

                document.getElementById('driverInfo').classList.remove('hidden');



                if (routeControl) {

                    try {

                        map.removeControl(routeControl);

                    } catch (e) {

                        console.warn('Route control removal failed', e);

                    }

                }



                try {

                    routeControl = L.Routing.control({

                        waypoints: [

                            L.latLng(userLoc.latitude, userLoc.longitude),

                            L.latLng(data.latitude, data.longitude)

                        ],

                        routeWhileDragging: false,

                        show: false,

                        createMarker: () => null,

                        router: L.Routing.osrmv1({

                            // For production, replace with your OSRM server or paid service

                            serviceUrl: 'https://router.project-osrm.org/route/v1'

                        }),

                        lineOptions: { styles: [{ color: '#2563eb', weight: 5 }] }

                    }).addTo(map);

                } catch (error) {

                    console.warn('OSRM routing failed, falling back to straight line', error);

                    L.polyline([

                        [userLoc.latitude, userLoc.longitude],

                        [data.latitude, data.longitude]

                    ], { color: '#2563eb', weight: 5 }).addTo(map);

                }



                if (document.getElementById('liveTracking').checked && !liveTrackingInterval) {

                    toggleLiveTracking();

                }

            });

        } catch (error) {

            logError('Track ambulance failed', error);

        } finally {

            if (button) button.classList.remove('loading');

        }

    }



    // Toggle live tracking

    function toggleLiveTracking() {

        try {

            const liveTracking = document.getElementById('liveTracking').checked;

            if (liveTracking && !liveTrackingInterval) {

                liveTrackingInterval = setInterval(() => trackAmbulance(), 10000);

                showNotification('Live tracking enabled.', 'success', '📍');

            } else if (!liveTracking && liveTrackingInterval) {

                clearInterval(liveTrackingInterval);

                liveTrackingInterval = null;

                showNotification('Live tracking disabled.', 'info', 'ℹ️');

            }

        } catch (error) {

            logError('Toggle live tracking failed', error);

        }

    }



    // Zoom to user

    function zoomToUser(event) {

        const button = event.target;

        if (!button) return;

        try {

            if (!userLocation || !map) return;

            map.setView([userLocation.latitude, userLocation.longitude], mapSettings.zoom);

        } catch (error) {

            logError('Zoom to user failed', error);

        }

    }



    // Zoom to ambulance

    function zoomToAmbulance(event) {

        const button = event.target;

        if (!button) return;

        try {

            const trackId = document.getElementById('trackId').value.trim();

            if (!trackingData[trackId] || !map) return;

            const data = trackingData[trackId];

            map.setView([data.latitude, data.longitude], mapSettings.zoom);

        } catch (error) {

            logError('Zoom to ambulance failed', error);

        }

    }



    // Call emergency

    async function callEmergency(event) {

        const button = event.target;

        if (!button) return;

        try {

            button.classList.add('loading');

            const contacts = users[loggedInId]?.emergencyContacts || [];

            if (contacts.length === 0) {

                showModal('No emergency contacts found.');

                return;

            }

            contacts.forEach(contact => {

                showNotification(`Simulated emergency call to ${contact.name} (${contact.phone}).`, 'success', '📞');

            });

        } catch (error) {

            logError('Call emergency failed', error);

        } finally {

            button.classList.remove('loading');

        }

    }



    // Start tracking

    async function startTracking(event) {

        const button = event.target;

        if (!button) return;

        try {

            button.classList.add('loading');

            if (!isLoggedIn || loggedInType !== 'driver') {

                showModal('Please log in as a driver.');

                return;

            }



            if (watchId) {

                showModal('Tracking already active.');

                return;

            }



            navigator.geolocation.watchPosition(

                position => {

                    const lat = position.coords.latitude;

                    const lng = position.coords.longitude;

                    trackingData[loggedInId] = {

                        latitude: lat,

                        longitude: lng,

                        name: loggedInName,

                        timestamp: new Date().toISOString()

                    };

                    if (!locationHistory[loggedInId]) locationHistory[loggedInId] = [];

                    locationHistory[loggedInId].push({

                        latitude: lat,

                        longitude: lng,

                        timestamp: new Date().toISOString()

                    });

                    if (locationHistory[loggedInId].length > 50) locationHistory[loggedInId].shift();

                    localStorage.setItem('trackingData', JSON.stringify(trackingData));

                    localStorage.setItem('locationHistory', JSON.stringify(locationHistory));

                    updateDashboard();

                    updateAdminPanel();

                },

                error => {

                    logError('Tracking failed', error);

                    showModal('Failed to track location.');

                },

                { enableHighAccuracy: true, timeout: 15000 }

            );

            watchId = true;

            document.getElementById('startTrackBtn').disabled = true;

            document.getElementById('stopTrackBtn').disabled = false;

            showNotification('Tracking started.', 'success', '📍');

        } catch (error) {

            logError('Start tracking failed', error);

        } finally {

            button.classList.remove('loading');

        }

    }



    // Stop tracking

    function stopTracking() {

        try {

            if (watchId) {

                navigator.geolocation.clearWatch(watchId);

                watchId = null;

            }

            delete trackingData[loggedInId];

            localStorage.setItem('trackingData', JSON.stringify(trackingData));

            document.getElementById('startTrackBtn').disabled = false;

            document.getElementById('stopTrackBtn').disabled = true;

            showNotification('Tracking stopped.', 'success', '✅');

        } catch (error) {

            logError('Stop tracking failed', error);

        }

    }



    // Toggle availability

    async function toggleAvailability(event) {

        const button = event.target;

        if (!button) return;

        try {

            button.classList.add('loading');

            if (!isLoggedIn || loggedInType !== 'driver') {

                showModal('Please log in as a driver.');

                return;

            }



            driverAvailability[loggedInId] = driverAvailability[loggedInId] === 'Available' ? 'Busy' : 'Available';

            localStorage.setItem('driverAvailability', JSON.stringify(driverAvailability));

            document.getElementById('driverAvailability').textContent = driverAvailability[loggedInId];

            document.getElementById('driverAvailability').className = driverAvailability[loggedInId] === 'Available' ? 'status-available' : 'status-busy';

            updateDashboard();

            updateAdminPanel();

            showNotification(`Availability set to ${driverAvailability[loggedInId]}.`, 'success', '✅');

        } catch (error) {

            logError('Toggle availability failed', error);

        } finally {

            button.classList.remove('loading');

        }

    }



    // Update driver map

    function updateDriverMap() {

        try {

            if (!driverMap) {

                initMap(0, 0, 'driverMap');

                document.getElementById('driverMap').classList.remove('hidden');

            }



            getUserLocation(userLoc => {

                if (!userLoc) return;



                if (userMarker) driverMap.removeLayer(userMarker);

                userMarker = L.marker([userLoc.latitude, userLoc.longitude], {

                    icon: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41] })

                }).addTo(driverMap).bindPopup('User Location');



                const userBookings = bookingHistory[loggedInId] || [];

                const latestBooking = userBookings[userBookings.length - 1];

                if (!latestBooking) return;



                const userId = Object.keys(bookingHistory).find(uid => bookingHistory[uid].some(b => b.ambulanceId === loggedInId && b.status === 'Confirmed'));

                const userLocData = userLocations[userId];

                if (userLocData) {

                    userMarker.setLatLng([userLocData.latitude, userLocData.longitude]);

                    if (routeControl) {

                        try {

                            driverMap.removeControl(routeControl);

                        } catch (e) {

                            console.warn('Route control removal failed', e);

                        }

                    }

                    try {

                        routeControl = L.Routing.control({

                            waypoints: [

                                L.latLng(userLoc.latitude, userLoc.longitude),

                                L.latLng(userLocData.latitude, userLocData.longitude)

                            ],

                            routeWhileDragging: false,

                            show: false,

                            createMarker: () => null,

                            router: L.Routing.osrmv1({

                                // For production, replace with your OSRM server or paid service

                                serviceUrl: 'https://router.project-osrm.org/route/v1'

                            }),

                            lineOptions: { styles: [{ color: '#2563eb', weight: 5 }] }

                        }).addTo(driverMap);

                    } catch (error) {

                        console.warn('OSRM routing failed, falling back to straight line', error);

                        L.polyline([

                            [userLoc.latitude, userLoc.longitude],

                            [userLocData.latitude, userLocData.longitude]

                        ], { color: '#2563eb', weight: 5 }).addTo(driverMap);

                    }

                }

            });

        } catch (error) {

            logError('Update driver map failed', error);

        }

    }



    // Update dashboard

    function updateDashboard() {

        try {

            const tbody = document.getElementById('dashboardTable');

            tbody.innerHTML = '';

            Object.entries(trackingData).forEach(([id, data]) => {

                const row = document.createElement('tr');

                const avgRating = calculateDriverRating(id);

                row.innerHTML = `

                    <td>${data.name || 'N/A'}</td>

                    <td>${id}</td>

                    <td>${drivers[id]?.ambulanceType || 'N/A'}</td>

                    <td>${data.latitude.toFixed(4)}</td>

                    <td>${data.longitude.toFixed(4)}</td>

                    <td>${new Date(data.timestamp).toLocaleString()}</td>

                    <td><span class="status-online">Online</span></td>

                    <td><span class="${driverAvailability[id] === 'Available' ? 'status-available' : 'status-busy'}">${driverAvailability[id] || 'Unknown'}</span></td>

                    <td>${avgRating ? avgRating.toFixed(1) + ' ★' : 'No ratings'}</td>

                    <td><button onclick="document.getElementById('trackId').value = '${id}'; showSection('trackerSection'); trackAmbulance();">Track</button></td>

                `;

                tbody.appendChild(row);

            });

        } catch (error) {

            logError('Update dashboard failed', error);

        }

    }



    // Update admin panel

    function updateAdminPanel() {

        try {

            const pendingTbody = document.getElementById('pendingTable');

            const adminTbody = document.getElementById('adminTable');

            const historyTbody = document.getElementById('historyTable');

            const feedbackTbody = document.getElementById('feedbackTable');

            const messageTbody = document.getElementById('messageTable');

            const chatTbody = document.getElementById('chatTable');



            pendingTbody.innerHTML = '';

            Object.entries(pendingDrivers).forEach(([id, data]) => {

                const row = document.createElement('tr');

                row.innerHTML = `

                    <td>${data.name}</td>

                    <td>${id}</td>

                    <td>${data.ambulanceType}</td>

                    <td>

                        <button onclick="approveDriver('${id}')">Approve</button>

                        <button onclick="rejectDriver('${id}')">Reject</button>

                    </td>

                `;

                pendingTbody.appendChild(row);

            });



            adminTbody.innerHTML = '';

            Object.entries(drivers).forEach(([id, data]) => {

                const row = document.createElement('tr');

                const avgRating = calculateDriverRating(id);

                row.innerHTML = `

                    <td>${data.name}</td>

                    <td>${id}</td>

                    <td>${data.ambulanceType}</td>

                    <td><span class="${trackingData[id] ? 'status-online' : 'status-offline'}">${trackingData[id] ? 'Online' : 'Offline'}</span></td>

                    <td><span class="${driverAvailability[id] === 'Available' ? 'status-available' : 'status-busy'}">${driverAvailability[id] || 'Unknown'}</span></td>

                    <td>${avgRating ? avgRating.toFixed(1) + ' ★' : 'No ratings'}</td>

                    <td><button onclick="removeDriver('${id}')">Remove</button></td>

                `;

                adminTbody.appendChild(row);

            });



            historyTbody.innerHTML = '';

            Object.entries(locationHistory).forEach(([id, locations]) => {

                locations.forEach(loc => {

                    const row = document.createElement('tr');

                    row.innerHTML = `

                        <td>${id}</td>

                        <td>${loc.latitude.toFixed(4)}</td>

                        <td>${loc.longitude.toFixed(4)}</td>

                        <td>${new Date(loc.timestamp).toLocaleString()}</td>

                    `;

                    historyTbody.appendChild(row);

                });

            });



            feedbackTbody.innerHTML = '';

            feedbackData.forEach(f => {

                const row = document.createElement('tr');

                row.innerHTML = `

                    <td>${f.userId}</td>

                    <td>${f.driverId}</td>

                    <td>${f.feedback}</td>

                    <td>${f.rating} ★</td>

                    <td>${new Date(f.timestamp).toLocaleString()}</td>

                `;

                feedbackTbody.appendChild(row);

            });



            messageTbody.innerHTML = '';

            messages.forEach(msg => {

                const row = document.createElement('tr');

                row.innerHTML = `

                    <td>${msg.userId}</td>

                    <td>${msg.driverId}</td>

                    <td>${msg.message}</td>

                    <td>${new Date(msg.timestamp).toLocaleString()}</td>

                `;

                messageTbody.appendChild(row);

            });



            chatTbody.innerHTML = '';

            chats.forEach(chat => {

                const row = document.createElement('tr');

                row.innerHTML = `

                    <td>${chat.userId}</td>

                    <td>${chat.driverId}</td>

                    <td>${chat.message} (from ${chat.sender})</td>

                    <td>${new Date(chat.timestamp).toLocaleString()}</td>

                `;

                chatTbody.appendChild(row);

            });



            document.getElementById('activeDrivers').textContent = Object.keys(trackingData).length;

            document.getElementById('totalFeedback').textContent = feedbackData.length;

            document.getElementById('totalMessages').textContent = messages.length;

            document.getElementById('totalChats').textContent = chats.length;

        } catch (error) {

            logError('Update admin panel failed', error);

        }

    }



    // Approve driver

    function approveDriver(driverId) {

        try {

            if (pendingDrivers[driverId]) {

                drivers[driverId] = pendingDrivers[driverId];

                delete pendingDrivers[driverId];

                localStorage.setItem('drivers', JSON.stringify(drivers));

                localStorage.setItem('pendingDrivers', JSON.stringify(pendingDrivers));

                updateAdminPanel();

                showNotification(`Driver ${driverId} approved.`, 'success', '✅');

            }

        } catch (error) {

            logError('Approve driver failed', error);

        }

    }



    // Reject driver

    function rejectDriver(driverId) {

        try {

            if (pendingDrivers[driverId]) {

                delete pendingDrivers[driverId];

                localStorage.setItem('pendingDrivers', JSON.stringify(pendingDrivers));

                updateAdminPanel();

                showNotification(`Driver ${driverId} rejected.`, 'success', '✅');

            }

        } catch (error) {

            logError('Reject driver failed', error);

        }

    }



    // Remove driver

    function removeDriver(driverId) {

        try {

            delete drivers[driverId];

            delete trackingData[driverId];

            delete driverAvailability[driverId];

            delete locationHistory[driverId];

            localStorage.setItem('drivers', JSON.stringify(drivers));

            localStorage.setItem('trackingData', JSON.stringify(trackingData));

            localStorage.setItem('driverAvailability', JSON.stringify(driverAvailability));

            localStorage.setItem('locationHistory', JSON.stringify(locationHistory));

            updateAdminPanel();

            showNotification(`Driver ${driverId} removed.`, 'success', '✅');

        } catch (error) {

            logError('Remove driver failed', error);

        }

    }



    // Export history

    function exportHistory() {

        try {

            let csv = 'Driver ID,Latitude,Longitude,Timestamp\n';

            Object.entries(locationHistory).forEach(([id, locations]) => {

                locations.forEach(loc => {

                    csv += `${id},${loc.latitude},${loc.longitude},${loc.timestamp}\n`;

                });

            });

            const blob = new Blob([csv], { type: 'text/csv' });

            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');

            a.href = url;

            a.download = 'location_history.csv';

            a.click();

            URL.revokeObjectURL(url);

            showNotification('History exported.', 'success', '✅');

        } catch (error) {

            logError('Export history failed', error);

        }

    }



    // Update booking

    function updateBooking() {

        try {

            updateBookingHistory();

            document.getElementById('chatContainer').classList.remove('hidden');

        } catch (error) {

            logError('Update booking failed', error);

        }

    }



    // Toggle theme

    function toggleTheme() {

        try {

            document.body.classList.toggle('dark-mode');

            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');

            document.getElementById('themeToggle').textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';

        } catch (error) {

            logError('Toggle theme failed', error);

        }

    }



    // Initialize app

    function initApp() {

        try {

            if (localStorage.getItem('theme') === 'dark') {

                document.body.classList.add('dark-mode');

                document.getElementById('themeToggle').textContent = '☀️';

            }

            updateNavbar();

            showSection('homeSection');

            document.getElementById('accountType').addEventListener('change', toggleLoginFields);

            toggleLoginFields();

        } catch (error) {

            logError('App initialization failed', error);

        }

    }



    // Event listeners

    document.getElementById('hamburger').addEventListener('click', () => toggleMenu());

    document.getElementById('navHome').addEventListener('click', () => showSection('homeSection'));

    document.getElementById('navLogin').addEventListener('click', () => showSection('loginSection'));

    document.getElementById('navTracker').addEventListener('click', () => showSection('trackerSection'));

    document.getElementById('navDashboard').addEventListener('click', () => showSection('dashboardSection'));

    document.getElementById('themeToggle').addEventListener('click', toggleTheme);

    document.getElementById('logoutLink').addEventListener('click', logout);

    document.getElementById('registerBtn').addEventListener('click', registerAccount);

    document.getElementById('loginBtn').addEventListener('click', loginAccount);

    document.getElementById('userLogoutBtn').addEventListener('click', logout);

    document.getElementById('driverLogoutBtn').addEventListener('click', logout);

    document.getElementById('adminLogoutBtn').addEventListener('click', logout);

    document.getElementById('trackBtn').addEventListener('click', trackAmbulance);

    document.getElementById('modalCloseBtn').addEventListener('click', closeModal);

    document.getElementById('confirmBookingBtn').addEventListener('click', confirmBooking);

    document.getElementById('cancelBookingBtn').addEventListener('click', closeModal);

    document.getElementById('closeNotificationBtn').addEventListener('click', hideNotification);

    document.getElementById('routeType').addEventListener('change', () => {

        mapSettings.routeType = document.getElementById('routeType').value;

        localStorage.setItem('mapSettings', JSON.stringify(mapSettings));

        trackAmbulance();

    });

    document.getElementById('liveTracking').addEventListener('change', toggleLiveTracking);

    document.getElementById('weatherOverlay').addEventListener('change', toggleWeatherOverlay);

    document.getElementById('exportHistoryBtn').addEventListener('click', exportHistory);

    document.getElementById('sosBtn').addEventListener('click', sendSOS);

    document.getElementById('findAmbulanceBtn').addEventListener('click', findNearestAmbulance);

    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);

    document.getElementById('submitFeedbackBtn').addEventListener('click', submitFeedback);

    document.getElementById('zoomUserBtn').addEventListener('click', zoomToUser);

    document.getElementById('zoomAmbulanceBtn').addEventListener('click', zoomToAmbulance);

    document.getElementById('callEmergencyBtn').addEventListener('click', callEmergency);

    document.getElementById('startTrackBtn').addEventListener('click', startTracking);

    document.getElementById('stopTrackBtn').addEventListener('click', stopTracking);

    document.getElementById('toggleAvailabilityBtn').addEventListener('click', toggleAvailability);

    document.getElementById('enableNotifications').addEventListener('change', toggleNotifications);

    document.getElementById('toggleLocationBtn').addEventListener('click', toggleLocationSharing);

    document.getElementById('addContactBtn').addEventListener('click', addEmergencyContact);

    document.getElementById('updateProfileBtn').addEventListener('click', updateProfilePic);

    document.getElementById('updateDriverProfileBtn').addEventListener('click', updateDriverProfilePic);

    document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);

    document.getElementById('sendDriverChatBtn').addEventListener('click', sendDriverChatMessage);



    // Initialize

    initApp();

</script>

</body>

  </html>
